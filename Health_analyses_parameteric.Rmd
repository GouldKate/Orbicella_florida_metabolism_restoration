---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(reshape2)
library(cowplot)
library(magrittr)
library(lubridate)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(janitor)
library(rstatix)
library(dplyr)
library(grid)
library(gridExtra)
```

```{r}
setwd("C:/Github/Orbicella_FL/Raw Data")
healthT <- read.csv("Final_health_withtemps.csv")
head(healthT)

healthT<-healthT %>%
  clean_names()

str(healthT)

#health$date<-as.Date(health$date, format ="%m/%d/%y")
#health$reef<-as.factor(health$reef)
#health$coral_id<-as.factor(health$coral_id)
#health$genotype<-as.factor(health$genotype)
#health <- health %>% 
#     mutate_at(c(10:15,19), as.numeric)
#str(health)

healthT$date<-as.Date(healthT$date, format ="%m/%d/%y")
healthT$time<-as.factor(healthT$time)
healthT$reef<-as.factor(healthT$reef)
healthT$coral_id<-as.factor(healthT$coral_id)
healthT$genotype<-as.factor(healthT$genotype)

healthT <- healthT %>% 
     mutate_at(c(11,15:20,24), as.numeric)
str(healthT)
write.csv(healthT,"C:/Github/Orbicella_FL/R_dataOutput/healthT.csv")

```


```{r}
head(healthT)
################# remove June
healthT_jun<-subset(healthT, time!="4")
#Remove Feb
healthT_jun<-subset(healthT_jun, time!="0")
```

```{r}
library(moments)
##Checking non logged transformed portein data
ggdensity(healthT_jun$pale_living_tissue, 
          main = "Density plot",
          xlab = "Pale")
skewness(healthT_jun$pale_living_tissue, na.rm = TRUE)
#positively skewed

healthT_jun %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthT_jun %>% group_by(reef, genotype) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthT_jun %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthT_jun$logpale<-log(healthT_jun$pale_living_tissue+1)
# Distribution of CONT variable

ggdensity(healthT_jun, x = "logpale", fill = "lightgray", title = "logpale") +
  stat_overlay_normal_density(color = "red", linetype = "dashed")

skewness(healthT_jun$logpale, na.rm = TRUE)
shapiro.test(healthT_jun$logpale)
#SKEWED

##Checking non logged transformed  data
ggdensity(healthT_jun$white, 
          main = "Density plot",
          xlab = "white")
skewness(healthT_jun$white, na.rm = TRUE)
#positively skewed
healthT_jun %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthT_jun %>% group_by(reef, genotype) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthT_jun %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthT_jun$logwhite<-log(healthT_jun$white+1)
# Distribution of CONT variable

ggdensity(healthT_jun, x = "logwhite", fill = "lightgray", title = "logwhite") +
  stat_overlay_normal_density(color = "red", linetype = "dashed")

skewness(healthT_jun$logwhite, na.rm = TRUE)
shapiro.test(healthT_jun$logwhite)
#SKEWED

##Checking non logged transformed  data
ggdensity(healthT_jun$healthy_tissue, 
          main = "Density plot",
          xlab = "healthy")
skewness(healthT_jun$healthy_tissue, na.rm = TRUE)
#negatively skewed

healthT_jun %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthT_jun %>% group_by(reef, genotype) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthT_jun %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthT_jun$loghealthy<-log(healthT_jun$healthy_tissue+1)
# Distribution of CONT variable

ggdensity(healthT_jun, x = "loghealthy", fill = "lightgray", title = "loghealthy") +
  stat_overlay_normal_density(color = "red", linetype = "dashed")

skewness(healthT_jun$loghealthy, na.rm = TRUE)
shapiro.test(healthT_jun$loghealthy)
#SKEWED

##Checking non logged transformed  data
ggdensity(healthT_jun$mortality, 
          main = "Density plot",
          xlab = "mortality")
skewness(healthT_jun$mortality, na.rm = TRUE)
#positively skewed


healthT_jun %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthT_jun %>% group_by(reef, genotype) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthT_jun %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthT_jun$logmortality<-log(healthT_jun$mortality+1)
# Distribution of CONT variable

ggdensity(healthT_jun, x = "logmortality", fill = "lightgray", title = "logmortality") +
  stat_overlay_normal_density(color = "red", linetype = "dashed")

skewness(healthT_jun$logmortality, na.rm = TRUE)

shapiro.test(healthT_jun$logmortality)
#SKEWED

##Checking non logged transformed  data
ggdensity(healthT_jun$algae_growth, 
          main = "Density plot",
          xlab = "algae")
skewness(healthT_jun$algae_growth, na.rm = TRUE)
#positively skewed


healthT_jun %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthT_jun %>% group_by(reef, genotype, time) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthT_jun %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))


healthT_jun$logalgae<-log(healthT_jun$algae_growth+1)
# Distribution of CONT variable

ggdensity(healthT_jun, x = "logalgae", fill = "lightgray", title = "logalgae") +
  stat_overlay_normal_density(color = "red", linetype = "dashed")

skewness(healthT_jun$logalgae, na.rm = TRUE)

shapiro.test(healthT_jun$logalgae)
#SKEWED
```

GLM modelling:

```{r}
setwd("C:/Github/Orbicella_FL/Graphs/glm")
healthT_jun$cat <- paste(healthT_jun$reef,healthT_jun$genotype)

# change so model compares all reefs to home reef conch
healthT_jun <- within(healthT_jun, reef <- relevel(reef, ref = 2)) 

#################################################### P_Rate


#subset data for P-rate for additional compairisons 
p_ratedf<-healthT_jun[c(1:12,31)]
View(p_ratedf)
p_ratedf<-p_ratedf%>%drop_na()
#delete negative value p_rate 26
p_ratedf <- p_ratedf[-26,]
#fit logistic regression model logpale 3 factor model_ OVERaLL effect

p_ratedfeb<-subset(healthT, time =="0")
p_ratedfeb$cat <- paste(p_ratedfeb$reef,p_ratedfeb$genotype)
p_ratedfeb<-p_ratedfeb[c(1:2, 4:12,26)]

p_ratedfeb2<-p_ratedfeb%>%drop_na()
View(p_ratedfeb2)


######################################################################## means for compairisons
allP_rates<-p_ratedf %>% group_by(reef,genotype,time) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))
View(allP_rates)

p_ratedf %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))
# Cary had highiest P rates
#conch
#Looe
#Tenn
#  reef          n  mean    sd
#  <fct>     <int> <dbl> <dbl>
#1 Conch        20 1092.  608.
#2 Cary          8 1809. 1132.
#3 Looe         16  771.  356.
#4 Tennessee    11  666.  330.
p_ratedf %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))
# Genotype C had highest Prate
#D
#B
#A
#  genotype     n  mean    sd
#  <fct>    <int> <dbl> <dbl>
#1 A           13  943.  480.
#2 C           16 1155.  903.
#3 B           13  953.  793.
#4 D           13  988.  536.

p_ratedf %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))
#time 1 had highest P-rate
#3
#2
Gxep<-p_ratedf %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))
View(Gxep)
######################################################################## COnch (A) compairisons 
modelp <- glm(p_rate ~ reef *genotype*time, data=p_ratedf, family=poisson)
summary(modelp)
car::Anova(modelp, type=2)
pairs(emmeans(mod.orif, ~ reef*genotype))
#COnch reef A time 1= intercept
#Conch=Looe
#B=A
#All times differed
#conch A= Tenn C
p_ratedfc <- within(p_ratedf, cat <- relevel(cat, ref =16))
modelp <- glm(p_rate ~ cat, data=p_ratedfc, family=poisson)
summary(modelp)
###########################################################
p_ratedft <- within(p_ratedf, reef <- relevel(reef, ref = 2))
p_ratedft <- within(p_ratedf, genotype <- relevel(genotype, ref = 4))
modelpt <- glm(p_rate ~reef *genotype*time, data=p_ratedft, family=poisson)
summary(modelpt)

new.coralsid = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"), coral_id=p_ratedf$coral_id)

new.corals = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"))
                         
# this creates two vectors: $fit, which contains
# predicted probabilities and $se.fit
preds <- predict.glm(modelp,
                     newdata=new.corals,
                     type="response",
                     se.fit=T)
ppdf<- new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)
 
  new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)%>% 
ggplot(aes(factor(time), fit,
             ymin=lower, ymax=upper,
             group=genotype, color=genotype)) +
  geom_pointrange() +
    geom_line() +
  xlab("Survey Time") +
  ylab("Predicted Photosynthesis Rate")+
  facet_wrap(~reef, scales="free")+
  theme_classic()

 photopred<- ggplot(ppdf, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
  facet_wrap(~reef, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
  
 photopred
 

  
  photopredg<-ggplot(ppdf, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
  facet_wrap(~genotype, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
   photopredg      
   
  ggexport( photopredg, filename = "photopredg.pdf")
  
  
  
#################################################################
modelp <- glm(p_rate ~ reef*genotype, data= p_ratedf, family=poisson)
summary(modelp)

new.coralsidt = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), coral_id=p_ratedf$coral_id)

predsidt <- predict.glm(modelp,
                     newdata=new.coralsidt,
                     type="response",
                     se.fit=T)


new.corals2t<-new.coralsidt %>%
  mutate(fit = predsidt$fit,
         lower=fit - predsidt$se.fit,
         upper=fit + predsidt$se.fit) 



OP_dft<-merge(new.corals2t,p_ratedf)
OP_df2t <- unique(OP_dft)
    
photopredt<- ggplot(OP_df2t, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
  #facet_wrap(~reef, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
  
 photopredt

   ggexport( photopredt, filename = "photopredt.pdf")

   
#  
#predsid <- predict.glm(modelp,
#                     newdata=new.coralsid,
#                     type="response",
#                     se.fit=T)
#
#new.corals2<-new.coralsid %>%
#  mutate(fit = predsid$fit,
#         lower=fit - predsid$se.fit,
#         upper=fit + predsid$se.fit) 
#
#pdf<-healthT_junP[c(5:8,12)]
#pdf
#
#OP_df<-merge(new.corals2,pdf)
#OP_df2 <- unique(OP_df)
#
#photopred<-ggplot(OP_df2, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
#   geom_point()+
#    #geom_point(aes(x=time, y=p_rate))+  
#  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
#    geom_line(linetype= "dashed") +
#     scale_colour_manual(values=colors2)+
#  theme_classic()+
#  ylab("Photosynthesis rate (umol/kg)")+
#  xlab("")+
#  facet_wrap(~reef)+
#   theme(axis.text = element_text(size = 13))+
#  theme(axis.title = element_text(size = 14))
#photopred 
#
#ggexport(photopred, filename = "photopred.pdf")
#################################################################


#Subset by time
p_ratedfm<-subset(p_ratedf, time=="1")
p_ratedfa<-subset(p_ratedf, time=="2")
p_ratedfd<-subset(p_ratedf, time=="3")

p_ratedfeb2
####################################################compare reef*genotype at each time (Feb)

ggqqplot(p_ratedfeb2$p_rate)
shapiro.test(p_ratedfeb2$p_rate)
p_ratedfeb2$logp_rate<-log(p_ratedfeb2$p_rate+1)
ggqqplot(p_ratedfeb2$logp_rate)
shapiro.test(p_ratedfeb2$logp_rate)
bartlett.test(logp_rate~reef, data=p_ratedfeb2)

modelpmp <- lm(logp_rate ~ reef, data=p_ratedfeb2, family=poisson)
summary(modelpmp)
TukeyHSD(aov(modelpmp))
modelpmp <- glm(logp_rate ~ reef, data=p_ratedfeb2, family=poisson)
modelpmp <- glm(logp_rate ~ reef *genotype, data=p_ratedfeb2, family=poisson)
summary(modelpmp)
modelpmp <- glm(logp_rate ~ genotype, data=p_ratedfeb2, family=poisson)
summary(modelpmp)
# No diff in Feb
p_ratedfeb2 %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))

####################################################compare reef*genotype at each time (MAY)

ggqqplot(p_ratedfm$p_rate)
shapiro.test(p_ratedfm$p_rate)
bartlett.test(p_rate~reef, data=p_ratedfm)

modelpmp <- glm(p_rate ~ reef, data=p_ratedfm, family=poisson)
summary(modelpmp)
# Conch and Tenn Differ
modelpmp <- glm(p_rate ~ reef *genotype, data=p_ratedfm, family=poisson)
summary(modelpmp)
modelpmp <- glm(p_rate ~ genotype, data=p_ratedfm, family=poisson)
summary(modelpmp)
# All genotypes differ No diff in Feb


modelpmp <- glm(p_rate ~ reef *genotype, data=p_ratedfm, family=poisson)
summary(modelpmp)
#### only comparing Tenne and Conch
#Geno A=B
#tenn c= Conch A
p_ratedft <- within(p_ratedf, genotype <- relevel(reef, ref = 4))
modelpmp <- glm(p_rate ~ cat, data=p_ratedfm, family=poisson)
summary(modelpm)

p_ratedfm %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))

########################################### compare reef*genotype at each time (AUG)
modelpm <- glm(p_rate ~ reef *genotype, data=p_ratedfa, family=poisson)
summary(modelpm)

#no similarities
modelpm <- glm(p_rate ~ cat, data=p_ratedfa, family=poisson)
summary(modelpm)
#Conch A and Looe D
p_ratedfa %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))

###########################################compare reef*genotype at each time (DEC)
modelpm <- glm(p_rate ~ reef *genotype, data=p_ratedfd, family=poisson)
summary(modelpm)
#looe=COnch
modelpm <- glm(p_rate ~ cat, data=p_ratedfd, family=poisson)
summary(modelpm)

#Conch A and Looe A 
#################################################### pale_living_tissue
#subset data for Pale_living_tissue for additional compairisons 
pale_df<-healthT_jun[c(5:8, 20,31)]
View(pale_df)
pale_df<-pale_df%>%drop_na()

#############################################
allPa_rates<-pale_df %>% group_by(reef,genotype,time) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))
View(allPa_rates)

pale_df %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))
# Cary had the lowest paling
#  reef          n  mean    sd
#  <fct>     <int> <dbl> <dbl>
#1 Conch        43  19.6  27.2
#2 Cary         47  11.0  16.9
#3 Looe         46  26.3  35.1
#4 Tennessee    26  37.7  34.2
pale_df %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))
# Genotype C had lowest paling
#  genotype     n  mean    sd
#  <fct>    <int> <dbl> <dbl>
#1 A           44  24.3  32.0
#2 B           40  29.3  36.7
#3 C           39  16.3  22.9
#4 D           39  17.2  23.7
pale_df %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))
# time 3 had lowest paling
#  time      n  mean    sd
#  <fct> <int> <dbl> <dbl>
#1 1        61  20.0  30.7
#2 2        58  27.2  31.2
#3 3        43  17.5  25.6
Gxepa<-pale_df %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))
View(Gxepa)
#################################################################
#fit logistic regression model logpale 3 factor model_ OVERaLL effect
modelp <- glm(pale_living_tissue ~ reef*genotype*time, data= pale_df, family=poisson)
summary(modelp)
car::Anova(modelp, type=2)
#significant time diff
#overall Conch=Looe
#D=A
#Cary B=Conch A
#Looe C= Conch A
# Cary, Looe, TEnn D= Conch A
#Cary t3= Conch time 1
#gen B t2= gentype A t1
#D t2= A t1
#D t3- A t1
pale_dft <- within(pale_df, reef <- relevel(reef, ref = 2))
pale_dft <- within(pale_df, genotype <- relevel(genotype, ref = 3))
modelpt <- glm(pale_living_tissue ~reef *genotype*time, data=pale_dft, family=poisson)
summary(modelpt)

pale_dfc <- within(pale_df, cat <- relevel(cat, ref = 9))
modelp <- glm(pale_living_tissue ~ cat, data=pale_dfc, family=poisson)
summary(modelp)
#################################################################

new.corals = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"))

# this creates two vectors: $fit, which contains
# predicted probabilities and $se.fit
preds <- predict.glm(modelp,
                     newdata=new.corals,
                     type="response",
                     se.fit=T)

ppdf<- new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)
 
  new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)%>% 
ggplot(aes(factor(time), fit,
             ymin=lower, ymax=upper,
             group=genotype, color=genotype)) +
  geom_pointrange() +
    geom_line() +
  xlab("Survey Time") +
  ylab("Predicted Pale Tissue")+
  facet_wrap(~reef, scales="free")+
  theme_classic()

# palepreds<- ggplot(ppdf, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
#   geom_point()+
#    #geom_point(aes(x=time, y=p_rate))+  
#  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
#    geom_line(linetype= "dashed") +
#     scale_colour_manual(values=colors2)+
#  theme_classic()+
#  ylab("Pale Tissue (%)")+
#  xlab("")+
#  facet_wrap(~reef, scales="free")+
#   theme(axis.text = element_text(size = 13))+
#  theme(axis.title = element_text(size = 14))
# palepreds
#   ggexport(palepreds, filename = "palepreds.pdf")

 # 
 # ggplot(ppdf, aes(x=time, y=fit, colour=reef, group=reef)) + 
 #  geom_point()+
 #   #geom_point(aes(x=time, y=p_rate))+  
 # geom_errorbar(aes(ymin=lower, ymax=upper), width=.2) +
 #   geom_line(linetype= "dashed") +
 #    scale_colour_manual(values=colors2)+
 # theme_classic()+
 # ylab("Pale Tissue (%)")+
 # xlab("")+
 # facet_wrap(~genotype, scales="free")+
 #  theme(axis.text = element_text(size = 13))+
 # theme(axis.title = element_text(size = 14))


new.coralsid = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"), coral_id=pale_df$coral_id)

predsid <- predict.glm(modelp,
                     newdata=new.coralsid,
                     type="response",
                     se.fit=T)


new.corals2<-new.coralsid %>%
  mutate(fit = predsid$fit,
         lower=fit - predsid$se.fit,
         upper=fit + predsid$se.fit) 



OP_df<-merge(new.corals2,pale_df)
OP_df2 <- unique(OP_df)

palepred<-ggplot(OP_df2, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Pale Tissue (%)")+
  xlab("")+
  facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
palepred 

ggexport(palepred, filename = "palepred.pdf")

palepredg<-ggplot(OP_df2, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Pale Tissue (%)")+
  xlab("")+
  facet_wrap(~genotype, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
palepredg 

ggexport(palepredg, filename = "palepredg.pdf")
#################################################################
modelp <- glm(pale_living_tissue ~ reef*genotype, data= pale_df, family=poisson)
summary(modelp)

new.coralsidt = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), coral_id=pale_df$coral_id)

predsidt <- predict.glm(modelp,
                     newdata=new.coralsidt,
                     type="response",
                     se.fit=T)


new.corals2t<-new.coralsidt %>%
  mutate(fit = predsidt$fit,
         lower=fit - predsidt$se.fit,
         upper=fit + predsidt$se.fit) 



OP_dft<-merge(new.corals2t,pale_df)
OP_df2t <- unique(OP_dft)

palepredt<-ggplot(OP_df2t, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Pale Tissue (%)")+
  xlab("")+
  #facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
palepredt 

ggexport(palepredt, filename = "palepredt.pdf")


####################################################
#Subset by time
pale_dfm<-subset(pale_df, time=="1")
pale_dfa<-subset(pale_df, time=="2")
pale_dfd<-subset(pale_df, time=="3")
####################################################compare reef*genotype at each time (MAY)
modelpm <- glm(pale_living_tissue ~ reef *genotype, data=pale_dfm, family=poisson)
summary(modelpm)
# Conch= Looe
#A=D
#CaryB= Conch A
#looe C= conch A
#Cary D= COnch A
#Looe D= Conch A
#Tenn D= COnch A
modelpm <- glm(pale_living_tissue ~ cat, data=pale_dfm, family=poisson)
summary(modelpm)
########################################### compare reef*genotype at each time (AUG)
modelpm <- glm(pale_living_tissue ~ reef *genotype, data=pale_dfa, family=poisson)
summary(modelpm)
#
#D &B= A
#Cary, Looe, Tenn B= Conch A
#Cary, Looe, Tenn D= Conch A
###########################################compare reef*genotype at each time (DEC)
modelpm <- glm(pale_living_tissue ~ reef *genotype, data=pale_dfd, family=poisson)
summary(modelpm)
#CAry B= Conch A
#Looe C= Conch A
#Cary D = Conch A
#################################################### white
#subset data for Pale_living_tissue for additional compairisons 
white_df<-healthT_jun[c(5:8, 18, 31)]
View(white_df)
white_df<-white_df%>%drop_na()
###########################################################################

allwhi_rates<-white_df %>% group_by(reef,genotype,time) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))
View(allwhi_rates)

Reef<-white_df %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))
#Conch has lowest bleaching 
Reef
#  reef          n  mean    sd
#  <fct>     <int> <dbl> <dbl>
#1 Conch        43  6.53  13.0
#2 Cary         47 10.7   16.4
#3 Looe         46 16.9   27.2
#4 Tennessee    26 11.1   14.6
white_df %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))
#  genotype     n  mean    sd
#  <fct>    <int> <dbl> <dbl>
#1 A           44 13.5   24.2
#2 B           40 10.8   20.0
#3 C           39  9.85  14.0
#4 D           39 11.3   17.7
#Genotype A had lowest bleaching
white_df %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))


#time 3 had lowest bleaching
# time      n  mean    sd
# <fct> <int> <dbl> <dbl>
# 1        61 10.8   21.7
# 2        58 15.3   20.2
# 3        43  7.02  13.0

RHT<-white_df %>% group_by(coral_id,reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))
write.csv(RHT, "RHT.csv")

bleach<-white_df %>% group_by(time, reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

Augbleach<-subset(bleach, time=="2")
Decbleach<-subset(bleach, time=="2")

Gxew<-white_df %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))
View(Gxew)
##########################################################################

#fit logistic regression model logpale 3 factor model_ OVERaLL effect
modelp <- glm(white ~ reef *genotype*time, data=white_df, family=poisson)
summary(modelp)
car::Anova(modelp, type=2)
#significant time diff
#overall Conch=cary
#D=A=B=C
#cary B =Conch A
#Looe C= Conch A
#all D= Conch A

white_dft <- within(white_df, reef <- relevel(reef, ref = 3))
modelpt <- glm(white ~reef*genotype*time, data=white_dft, family=poisson)
summary(modelpt)

white_dfc <- within(white_df, cat <- relevel(cat, ref = 12))
modelp <- glm(white ~ cat, data=white_dfc, family=poisson)
summary(modelp)
########################################
        
new.corals = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"))
                         
# this creates two vectors: $fit, which contains
# predicted probabilities and $se.fit
preds <- predict.glm(modelp,
                     newdata=new.corals,
                     type="response",
                     se.fit=T)

ppdf<- new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)
 
  new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)%>% 
ggplot(aes(factor(time), fit,
             ymin=lower, ymax=upper,
             group=genotype, color=genotype)) +
  geom_pointrange() +
    geom_line() +
  xlab("Survey Time") +
  ylab("Predicted White Tissue")+
  facet_wrap(~reef, scales="free")+
  theme_classic()

  ggplot(ppdf, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("White Tissue (%)")+
  xlab("")+
  facet_wrap(~reef, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
  
  
  


new.coralsid = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"), coral_id=white_df$coral_id)

predsid <- predict.glm(modelp,
                     newdata=new.coralsid,
                     type="response",
                     se.fit=T)


new.corals2<-new.coralsid %>%
  mutate(fit = predsid$fit,
         lower=fit - predsid$se.fit,
         upper=fit + predsid$se.fit) 



OP_df<-merge(new.corals2,white_df)
OP_df2 <- unique(OP_df)

whitepred<-ggplot(OP_df2, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("White Tissue (%)")+
  xlab("")+
  facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
whitepred 

ggexport(whitepred, filename = "whitepred.pdf")

whitepredg<-ggplot(OP_df2, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("White Tissue (%)")+
  xlab("")+
  facet_wrap(~genotype, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
whitepredg 

ggexport(whitepredg, filename = "whitepredg.pdf")
#################################################################
whitepredgc<-ggplot(OP_df2, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("White Tissue (%)")+
  xlab("")+
  facet_wrap(~genotype)+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
whitepredgc 

ggexport(whitepredgc, filename = "whitepredgc.pdf")
#################################################################
modelp <- glm(white ~ reef*genotype, data= white_df, family=poisson)
summary(modelp)

new.coralsidt = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), coral_id=white_df$coral_id)

predsidt <- predict.glm(modelp,
                     newdata=new.coralsidt,
                     type="response",
                     se.fit=T)


new.corals2t<-new.coralsidt %>%
  mutate(fit = predsidt$fit,
         lower=fit - predsidt$se.fit,
         upper=fit + predsidt$se.fit) 



OP_dft<-merge(new.corals2t,white_df)
OP_df2t <- unique(OP_dft)

whitepredt<-ggplot(OP_df2t, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Bleached Tissue (%)")+
  xlab("")+
  #facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
whitepredt 

ggexport(whitepredt, filename = "whitepredt.pdf")


#Subset by time
white_dfm<-subset(white_df, time=="1")
white_dfa<-subset(white_df, time=="2")
white_dfd<-subset(white_df, time=="3")
####################################################compare reef*genotype at each time (MAY)
modelpm <- glm(white ~ reef *genotype, data=white_dfm, family=poisson)
summary(modelpm)
# Conch= Cary
#A=B
#A=D
#CaryB= Conch A
#looe C= conch A
#Cary D= COnch A
#Looe D= Conch A
#Tenn D= COnch A
modelpm <- glm(white ~ cat, data=white_dfm, family=poisson)
summary(modelpm)
########################################### compare reef*genotype at each time (AUG)
modelpm <- glm(white ~ reef , data=white_dfa, family=poisson)
summary(modelpm)
#Conch reef differed 

white_dfa %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))
###########################################compare reef*genotype at each time (DEC)
modelpm <- glm(white ~ reef *genotype, data=white_dfd, family=poisson)
summary(modelpm)
#Cary and Looe different from Conch # this is confusing
#D=A
#Looe B C= Conch A
#Cary B C D = Conch A
white_dfd %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

####################################################  MOrtality
#subset data for Pale_living_tissue for additional compairisons 
mort_df<-healthT_jun[c(5:8, 16,31)]
View(mort_df)
mort_df<-mort_df%>%drop_na()
###########################################################################

allmort_rates<-mort_df %>% group_by(reef,genotype,time) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))
View(allmort_rates)

mort_df %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))
#Cary has lowest mortlaity 
#  reef          n  mean    sd
#  <fct>     <int> <dbl> <dbl>
#1 Conch        43  2.33  5.44
#2 Cary         47  1.72  4.03
#3 Looe         46  2.26  4.29
#4 Tennessee    31 28    37.8 
mort_df %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))
#Genotype C had lowest mortality
#  genotype     n  mean    sd
#  <fct>    <int> <dbl> <dbl>
#1 A           44  6.23 17.1 
#2 B           42  6.88 21.6 
#3 C           39  5     8.46
#4 D           42  9.40 26.0 
mort_df %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))
#time 3 had lowest mortality
# time      n  mean    sd
# <fct> <int> <dbl> <dbl>
# 1        63  6.06 19.0 
# 2        61 11.8  24.7 
# 3        43  1.16  4.67
Gxem<-mort_df %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))
View(Gxem)

###########################################################################
#fit logistic regression model mortality 3 factor model_ OVERaLL effect
modelp <- glm(mortality ~ reef *genotype*time, data=mort_df, family=poisson)
summary(modelp)
car::Anova(modelp, type="II")
#significant time diff
#overall Conch=cary & Looe
#A= B &D
#times differed
#Tenn C differed from conch A

#mort_dft <- within(mort_df, genotype <- relevel(genotype, ref = ))
mort_dft <- within(mort_df, reef <- relevel(reef, ref = 3))
modelpt <- glm(mortality ~reef *genotype*time, data=mort_dft, family=poisson)
summary(modelpt)

mort_dfc <- within(mort_df, cat <- relevel(cat, ref = 12))
modelp <- glm(mortality ~ cat, data=mort_dfc, family=poisson)
summary(modelp)
########################################
new.corals = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"))
          
# this creates two vectors: $fit, which contains
# predicted probabilities and $se.fit
preds <- predict.glm(modelp,
                     newdata=new.corals,
                     type="response",
                     se.fit=T)

ppdf<- new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)
 
  new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)%>% 
ggplot(aes(factor(time), fit,
             ymin=lower, ymax=upper,
             group=genotype, color=genotype)) +
  geom_pointrange() +
    geom_line() +
  xlab("Survey Time") +
  ylab("Predicted Tissue Mortality")+
  facet_wrap(~reef, scales="free")+
  theme_classic()
  

  ggplot(ppdf, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Mortality (%)")+
  xlab("")+
  facet_wrap(~reef, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
  
  
  
new.coralsid = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"), coral_id=mort_df$coral_id)

predsid <- predict.glm(modelp,
                     newdata=new.coralsid,
                     type="response",
                     se.fit=T)


new.corals2<-new.coralsid %>%
  mutate(fit = predsid$fit,
         lower=fit - predsid$se.fit,
         upper=fit + predsid$se.fit) 



OP_df<-merge(new.corals2,mort_df)
OP_df2 <- unique(OP_df)

mortpred<-ggplot(OP_df2, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Mortality (%)")+
  xlab("")+
  facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
mortpred 

ggexport(mortpred, filename = "mortpred.pdf")

mortpredg<-ggplot(OP_df2, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Mortality (%)")+
  xlab("")+
  facet_wrap(~genotype, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
mortpredg 

ggexport(mortpredg, filename = "mortpredg.pdf")

################################################################
mortpredgc<-ggplot(OP_df2, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Mortality (%)")+
  xlab("")+
  facet_wrap(~genotype)+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
mortpredgc 

ggexport(mortpredgc, filename = "mortpredgc.pdf")

#mort<-mort_df %>%
#  group_by(reef,genotype, time) %>%
#  dplyr::summarise(mean = mean(mortality, na.rm = TRUE),
#            sd = sd(mortality, na.rm = TRUE),
#            n = n()) %>%
#  mutate(se = sd / sqrt(n),
#         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
#         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
#  
#mort
#
#mortpredm<-ggplot(mort, aes(x=time, y=mean, colour=genotype, group=genotype)) + 
#   geom_point()+
#    #geom_point(aes(x=time, y=p_rate))+  
#  geom_errorbar(aes(ymin=lower.ci, ymax=upper.ci), width=.1) +
#    geom_line(linetype= "dashed") +
#     scale_colour_manual(values=colors2)+
#  theme_classic()+
#  ylab("Tissue Mortality (%)")+
#  xlab("")+
#  facet_wrap(~reef, scale="free")+
#   theme(axis.text = element_text(size = 13))+
#  theme(axis.title = element_text(size = 14))
#mortpredm

#ggexport(mortpredm , filename = "mortpredm.pdf")


#################################################################
modelp <- glm(mortality ~ reef*genotype, data= mort_df, family=poisson)
summary(modelp)

new.coralsidt = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), coral_id=mort_df$coral_id)

predsidt <- predict.glm(modelp,
                     newdata=new.coralsidt,
                     type="response",
                     se.fit=T)


new.corals2t<-new.coralsidt %>%
  mutate(fit = predsidt$fit,
         lower=fit - predsidt$se.fit,
         upper=fit + predsidt$se.fit) 



OP_dft<-merge(new.corals2t,mort_df)
OP_df2t <- unique(OP_dft)

mortpredt<-ggplot(OP_df2t, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Mortality (%)")+
  xlab("")+
  #facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
mortpredt 

ggexport(mortpredt, filename = "mortpredt.pdf")


#################################################################
#Subset by time
mort_dfm<-subset(mort_df, time=="1")
mort_dfa<-subset(mort_df, time=="2")
mort_dfd<-subset(mort_df, time=="3")
####################################################compare reef*genotype at each time (MAY)
modelpm <- glm(mortality ~ reef *genotype, data=mort_dfm, family=poisson)
summary(modelpm)
# Conch= Cary & Looe
#A=B
#A=D
#Tenn C differed from Conch A
########################################### compare reef*genotype at each time (AUG)
modelpm <- glm(mortality ~ reef *genotype, data=mort_dfa, family=poisson)
summary(modelpm)
#Tenn differed
#Tenn C differed from A
mort_dfa %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))
###########################################compare reef*genotype at each time (DEC)
modelpm <- glm(mortality ~ reef *genotype, data=mort_dfd, family=poisson)
summary(modelpm)
#All similar in Dec

####################################################  Algae
#subset data for Pale_living_tissue for additional compairisons 
alg_df<-healthT_jun[c(5:8, 15, 31)]
View(alg_df)
alg_df<-alg_df%>%drop_na()
###########################################################################

allalg_rates<-alg_df %>% group_by(reef,genotype,time) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))
View(allalg_rates)

alg_df %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))
#Tenn has most algae growth- Loooe 0.02 
#  reef          n    mean     sd
#  <fct>     <int>   <dbl>  <dbl>
#1 Conch        43  0       0    
#2 Cary         47  0       0    
#3 Looe         46  0.0217  0.147
#4 Tennessee    31 23.5    38.1  

alg_df %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))
#Genotype C had lowest algae_growth
#  genotype     n  mean    sd
#  <fct>    <int> <dbl> <dbl>
#1 A           44 3.02  13.7 
#2 B           42 5.36  21.8 
#3 C           39 0.897  3.95
#4 D           42 7.98  26.3 

alg_df %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))
 
##time 3 had lowest algae_growth (No tenn)
#  time      n  mean    sd
#  <fct> <int> <dbl> <dbl>
#1 1        63  3.43  17.7
#2 2        61  8.39  24.5
#3 3        43  0      0  
Gxea<-alg_df %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))
View(Gxea)

###########################################################################
alg_df$log<-log(alg_df$algae_growth+1)
#fit logistic regression model logpale 3 factor model_ OVERaLL effect
modelp <- glm(algae_growth ~ reef *genotype*time, data=alg_df, family=poisson)
summary(modelp)
car::Anova(modelp, type=2)
#
alg_dft <- within(alg_df, reef <- relevel(reef, ref = 4))
alg_dft <- within(alg_dft, genotype <- relevel(genotype, ref = 4))
modelpt <- glm(algae_growth ~ reef *genotype*time, data=alg_dft, family=poisson)
summary(modelpt)

alg_dfc <- within(alg_df, cat <- relevel(cat, ref = 16))
modelp <- glm(log ~ cat, data=alg_dfc, family=poisson)
summary(modelp)
##################################################################
new.corals = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"))
                         
# this creates two vectors: $fit, which contains
# predicted probabilities and $se.fit
preds <- predict.glm(modelp,
                     newdata=new.corals,
                     type="response",
                     se.fit=T)

ppdf<- new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)
 
  new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)%>% 
ggplot(aes(factor(time), fit,
             ymin=lower, ymax=upper,
             group=genotype, color=genotype)) +
  geom_pointrange() +
    geom_line() +
  xlab("Survey Time") +
  ylab("Predicted Algae Overgrowth")+
  facet_wrap(~reef, scales="free")+
  theme_classic()

  ggplot(ppdf, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Algae Overgrowth (%)")+
  xlab("")+
  facet_wrap(~reef, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
  
  
  


new.coralsid = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"), coral_id=alg_df$coral_id)

predsid <- predict.glm(modelp,
                     newdata=new.coralsid,
                     type="response",
                     se.fit=T)


new.corals2<-new.coralsid %>%
  mutate(fit = predsid$fit,
         lower=fit - predsid$se.fit,
         upper=fit + predsid$se.fit) 



OP_df<-merge(new.corals2,alg_df)
OP_df2 <- unique(OP_df)

algpred<-ggplot(OP_df2, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Algae Overgrowth (%)")+
  xlab("")+
  facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
algpred 

ggexport(algpred , filename = "algpred.pdf")

algpredg<-ggplot(OP_df2, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Algae Overgrowth (%)")+
  xlab("")+
  facet_wrap(~genotype, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
algpredg 

ggexport(algpredg, filename = "algpredg.pdf")

algpredgr<-ggplot(OP_df2, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue Algae Overgrowth (%)")+
  xlab("")+
  facet_wrap(~time, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
algpredgr 

ggexport(algpredg, filename = "algpredg.pdf")

#################################################################
modelp <- glm(algae_growth ~ reef*genotype, data= alg_df, family=poisson)
summary(modelp)

new.coralsidt = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), coral_id=alg_df$coral_id)

predsidt <- predict.glm(modelp,
                     newdata=new.coralsidt,
                     type="response",
                     se.fit=T)


new.corals2t<-new.coralsidt %>%
  mutate(fit = predsidt$fit,
         lower=fit - predsidt$se.fit,
         upper=fit + predsidt$se.fit) 



OP_dft<-merge(new.corals2t,alg_df)
OP_df2t <- unique(OP_dft)

algpredt<-ggplot(OP_df2t, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae Overgrowth (%)")+
  xlab("")+
  #facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
algpredt 

ggexport(algpredt, filename = "algpredt.pdf")

#################################################################
#Subset by time
alg_dfm<-subset(alg_df, time=="1")
alg_dfa<-subset(alg_df, time=="2")
alg_dfd<-subset(alg_df, time=="3")
####################################################compare reef*genotype at each time (MAY)
modelpm <- glm(algae_growth ~ reef *genotype, data=alg_dfm, family=poisson)
summary(modelpm)

alg_dfmc <- within(alg_dfm, cat <- relevel(cat, ref = 16))
modelpm <- glm(algae_growth ~ cat, data=alg_dfmc, family=poisson)
summary(modelpm)
########################################### compare reef*genotype at each time (AUG)
modelpm <- glm(algae_growth ~ reef *genotype, data=alg_dfa, family=poisson)
summary(modelpm)
#Tenn differed
#Tenn C differed from A
modelpm <- glm(algae_growth ~ cat, data=alg_dfa, family=poisson)
summary(modelpm)
###########################################compare reef*genotype at each time (DEC)
modelpm <- glm(algae_growth ~ reef *genotype, data=alg_dfd, family=poisson)
summary(modelpm)
#All similar in Dec

####################################################  healthy
#subset data for Pale_living_tissue for additional compairisons 
heal_df<-healthT_jun[c(5:8, 17, 31)]
View(heal_df)
heal_df<-heal_df%>%drop_na()
###########################################################################

allheal_rates<-heal_df %>% group_by(reef,genotype,time) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
View(allheal_rates)

heal_df %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
#Conch has most healthy
#Then Cary, Looe, Tenn
#  reef          n  mean    sd
#  <fct>     <int> <dbl> <dbl>
#1 Conch        43  91.1  15.0
#2 Cary         47  87.6  19.6
#3 Looe         46  80.8  30.1
#4 Tennessee    29  67    37.2

heal_df %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
#Genotype C had highest healthy_tissue
#  genotype     n  mean    sd
#  <fct>    <int> <dbl> <dbl>
#1 A           44  80.2  32.0
#2 B           42  82.8  28.8
#3 C           39  85.2  19.0
#4 D           40  84.2  25.6

heal_df %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
#time 3 had highiest healthy_tissue (No tenn)
#  time      n  mean    sd
#  <fct> <int> <dbl> <dbl>
#1 1        63  83.5  29.3
#2 2        59  76.1  29.2
#3 3        43  91.8  14.9
Gxeh<-heal_df %>% group_by(cat) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
View(Gxeh)

###########################################################################
#fit logistic regression model logpale 3 factor model_ OVERaLL effect
modelp <- glm(healthy_tissue ~ reef *genotype*time, data=heal_df, family=poisson)
summary(modelp)
car::Anova(modelp, type=2)
#Cary= Conch
#all genotypes =
#times are the same
#Looe B SD Conch A
#cary C SD conch A
#Looe C SD CA
#Tenn C SD CA
# Looe D SD CA
# diff in Looe times 2 and 3
#heal_dft <- within(heal_df, reef <- relevel(reef, ref = 4))
heal_dft <- within(heal_df, genotype <- relevel(genotype, ref = 1))
heal_dft <- within(heal_dft, reef <- relevel(reef, ref = 2))
modelpt <- glm(healthy_tissue ~ reef *genotype*time, data=heal_dft, family=poisson)
summary(modelpt)

heal_dfc <- within(heal_df, cat <- relevel(cat, ref = 16))
modelpt <- glm(healthy_tissue ~ cat, data=heal_dfc, family=poisson)
summary(modelpt)

new.corals = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"))
                         
# this creates two vectors: $fit, which contains
# predicted probabilities and $se.fit
preds <- predict.glm(modelp,
                     newdata=new.corals,
                     type="response",
                     se.fit=T)

ppdf<- new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)
 
  new.corals %>%
  mutate(fit = preds$fit,
         lower=fit - preds$se.fit,
         upper=fit + preds$se.fit)%>% 
ggplot(aes(factor(time), fit,
             ymin=lower, ymax=upper,
             group=genotype, color=genotype)) +
  geom_pointrange() +
    geom_line() +
  xlab("Survey Time") +
  ylab("Predicted Healthy Tissue")+
  facet_wrap(~reef, scales="free")+
  theme_classic()

 healpredtenn<- ggplot(ppdf, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy Tissue (%)")+
  xlab("")+
  facet_wrap(~reef, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
  
healpredtenn 

ggexport(healpredtenn , filename = "healpredtenn.pdf")  
  

 healpredtennr<- ggplot(ppdf, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy Tissue (%)")+
  xlab("")+
  facet_wrap(~time, scales="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
  
healpredtennr

ggexport(healpredtennr , filename = "healpredtennr.pdf")  

new.coralsid = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), time=c("1","2","3"), coral_id=heal_df$coral_id)

predsid <- predict.glm(modelp,
                     newdata=new.coralsid,
                     type="response",
                     se.fit=T)


new.corals2<-new.coralsid %>%
  mutate(fit = predsid$fit,
         lower=fit - predsid$se.fit,
         upper=fit + predsid$se.fit) 



OP_df<-merge(new.corals2,heal_df)
OP_df2 <- unique(OP_df)

healpred<-ggplot(OP_df2, aes(x=time, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy Tissue (%)")+
  xlab("")+
  facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
healpred 

ggexport(healpred , filename = "healpred.pdf")

healpredg<-ggplot(OP_df2, aes(x=time, y=fit, colour=reef, group=reef)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy Tissue (%)")+
  xlab("")+
  facet_wrap(~genotype, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
healpredg 

ggexport(healpredg, filename = "healpredg.pdf")

#################################################################
modelp <- glm(healthy_tissue ~ reef*genotype, data= heal_df, family=poisson)
summary(modelp)

new.coralsidt = expand.grid(reef=c("Cary", "Conch", "Looe", "Tennessee"), genotype=c("A", "B", "C", "D"), coral_id=heal_df$coral_id)

predsidt <- predict.glm(modelp,
                     newdata=new.coralsidt,
                     type="response",
                     se.fit=T)


new.corals2t<-new.coralsidt %>%
  mutate(fit = predsidt$fit,
         lower=fit - predsidt$se.fit,
         upper=fit + predsidt$se.fit) 



OP_dft<-merge(new.corals2t,heal_df)
OP_df2t <- unique(OP_dft)

healpredt<-ggplot(OP_df2t, aes(x=reef, y=fit, colour=genotype, group=genotype)) + 
   geom_point()+
    #geom_point(aes(x=time, y=p_rate))+  
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.1) +
    geom_line(linetype= "dashed") +
     scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy Tissue (%)")+
  xlab("")+
  #facet_wrap(~reef, scale="free")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
healpredt 

ggexport(healpredt, filename = "healpredt.pdf")

#################################################################
#Subset by time
heal_dfm<-subset(heal_df, time=="1")
heal_dfa<-subset(heal_df, time=="2")
heal_dfd<-subset(heal_df, time=="3")
####################################################compare reef*genotype at each time (MAY)
modelpm <- glm(healthy_tissue ~ reef *genotype, data=heal_dfm, family=poisson)
summary(modelpm)
# Cary= Conch
# B, C, D= A
#Looe B= Conch A

########################################### compare reef*genotype at each time (AUG)
modelpm <- glm(healthy_tissue ~ reef *genotype, data=heal_dfa, family=poisson)
summary(modelpm)
# Cary= Conch
# B, C, D= A
###########################################compare reef*genotype at each time (DEC)
modelpm <- glm(healthy_tissue ~ reef *genotype, data=heal_dfd, family=poisson)
summary(modelpm)
#D=A


```

```{r}

healthN<-healthT_jun # with time 0)
data_long2bd <- gather(healthN, condition, value, c(mortality, healthy_tissue, white, algae_growth, pale_living_tissue), factor_key=TRUE)
data_long2bd

AvgHplotbd<-ggplot(data_long2bd, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
  scale_fill_manual(values = colors3) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue (%)")+
    xlab("")+
  #scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  ggtitle("Overall Health")+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

AvgHplotbd
ggexport(AvgHplotbd, filename = "AvgHplotbp2d.pdf")

```

Binomial Data Presence/ Absence Data 
```{r}

HealthN<-subset(healthN, time !="0")
###################### healthy no differences 
#ggplot(healthN, aes(x = reef, fill = healthy_y_n)) +
#    geom_bar(position = "fill") +
#    theme_classic()+
#  facet_wrap(~time)
             
mod.orift <- glm(cbind(healthy_y_n)~time, data=healthN,family= "binomial")
summary(mod.orift)
#No difference in time
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype*time, data=healthN,family= "binomial")
summary(mod.orif)
mod.orifi <- glm(cbind(healthy_y_n)~reef*genotype, data=healthN,family= "binomial")
summary(mod.orifi)
mod.orifr <- glm(cbind(healthy_y_n)~reef, data=healthN,family= "binomial")
summary(mod.orifr)
mod.orifg <- glm(cbind(healthy_y_n)~genotype, data=healthN,family= "binomial")
summary(mod.orifg)
AIC(mod.orif,mod.orift,mod.orifi,mod.orifr,mod.orifg)
# all post-hoc comparisons:
library(emmeans)
pairs(emmeans(mod.orif, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orif, ~ genotype))
# No difference
pairs(emmeans(mod.orif, ~ reef))
# No difference

mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)

####################### Blotchy no differences
ggplot(healthN, aes(x = reef, fill = blotchy_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orih <- glm(cbind(blotchy_y_n)~time, data=healthN,family= "binomial")
summary(mod.orih)
# no difference in time
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype*time, data=healthN,family= "binomial")
summary(mod.orih)
# all post-hoc comparisons:
pairs(emmeans(mod.orih, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orih, ~ genotype))
# No difference
pairs(emmeans(mod.orih, ~ reef))
# No difference

mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orih)

####################### Disease presence no differences

ggplot(healthN, aes(x = reef, fill = disease_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orid <- glm(cbind(disease_y_n)~time, data=healthN,family= "binomial")
summary(mod.orid)
#no difference in time
mod.orid <- glm(cbind(disease_y_n)~reef*genotype*time, data=healthN,family= "binomial")
summary(mod.orid)
# all post-hoc comparisons:
pairs(emmeans(mod.orid, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orid, ~ genotype))
# No difference
pairs(emmeans(mod.orid, ~ reef))
# No difference

mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)

##################### Tumors no differences

ggplot(healthN, aes(x = reef, fill = tumor_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orit <- glm(cbind(tumor_y_n)~time, data=healthN,family= "binomial")
summary(mod.orit)
#no difference in time
mod.orit <- glm(cbind(tumor_y_n)~reef*genotype*time, data=healthN,family= "binomial")
summary(mod.orit)
# all post-hoc comparisons:
pairs(emmeans(mod.orit, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orit, ~ genotype))
# No difference
pairs(emmeans(mod.orit, ~ reef))
# No difference

mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)

######################### Boring No differences

ggplot(healthN, aes(x = reef, fill = boring_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orib <- glm(cbind(boring_y_n)~time, data=healthN,family= "binomial")
summary(mod.orib)
#No difference in time
mod.orib <- glm(cbind(boring_y_n)~reef*genotype*time, data=healthN,family= "binomial")
summary(mod.orib)
# all post-hoc comparisons:
pairs(emmeans(mod.orib, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orib, ~ genotype))
# No difference
pairs(emmeans(mod.orib, ~ reef))
# No difference
pairs(emmeans(mod.orib, ~ time))
##########
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)
#### 
```

```{r}
###############################
healthT_jun <- within(healthT_jun, reef <- relevel(reef, ref = 2)) 


# remove NA's from Pale_living tissue
healthT_junNA%>%drop_na()

  PCDF<-PCDF%>%drop_na()
#starting at zero influenced my intercepts and slopes which didn't predict the data well-

#fit logistic regression model logpale 3 factor model_ OVERaLL effect
modeli <- glm(pale_living_tissue ~ reef *genotype*time, data=healthT_jun, family=poisson)
summary(modeli)
AIC()
#Conch and looe not different
#genotype B and C are different from A-> A=D
#time 2 (aug) and 3(dec) are different than 1(may)
# interactions
##############
#Differs from Genotype A at Conch
# B at Looe
#
#
#
#
#
#
#
#
#
#

# subset data by timepoint
# exclude NA's for pal_tissue and those with NAs

# predict estiamtes from glm model and graph predicted genotype values at each site over time (4)

##Investigating the interaction
ggplot(aes(group= genotype,x=time, y=pale_living_tissue, color=genotype),data=healthT_jun)+
  geom_point()+
  #geom_line()+
  facet_wrap(~reef)


#Group the data by groups of interest by creating a new variable
healthT_jun$groups<-interaction(healthT_jun$reef, healthT_jun$genotype)
#Create a post-hoc model
model_posthoc<-with(healthT_jun, glm(logpale ~ groups, family=poisson()))
##Determine the post-hoc comparisons of interest
summary(glht(model_posthoc))

modeli <- glm(logpale ~ reef + genotype, data=healthT_jun, family=poisson)
summary(modeli)
#Tennessee 0.0397
1 - pchisq(deviance(modeli), df.residual(modeli))
#overdispersion 
drop1(modeli, test = "F")
modelg <- glm(logpale ~ genotype, data=healthT_jun, family=poisson)
summary(modelg)
# genotype A
modelr <- glm(logpale ~ reef , data=healthT_jun, family=poisson)
summary(modelr)
# carys fort and Tennessee
modelr <- glm(logpale ~ monrang , data=healthT_jun, family=poisson)
summary(modelr)
glht(modelr, mcp(reef="Tukey"))



library(multcomp)


#fit logistic regression model logwhite
modeli <- glm(logwhite ~ reef * genotype, data=healthT_jun, family=poisson)
summary(modeli)
#Looe reef- Geno C
modeli <- glm(logwhite ~ reef + genotype, data=healthT_jun, family=poisson)
summary(modeli)
#NS
modelg <- glm(logwhite ~ genotype, data=healthT_jun, family=poisson)
summary(modelg)
#Ns
modelr <- glm(logwhite ~ reef , data=healthT_jun, family=poisson)
summary(modelr)
#NS

#fit logistic regression model loghealthy
modeli <- glm(loghealthy ~ reef * genotype, data=healthT_jun, family=poisson)
summary(modeli)
#Carysfort
modeli <- glm(loghealthy ~ reef + genotype, data=healthT_jun, family=poisson)
summary(modeli)
#carysfort
modelg <- glm(loghealthy ~ genotype, data=healthT_jun, family=poisson)
summary(modelg)
#geno A
modelr <- glm(loghealthy ~ reef , data=healthT_jun, family=poisson)
summary(modelr)
#Carysfort

#fit logistic regression model logmortality
modeli <- glm(logmortality ~ reef * genotype, data=healthT_jun, family=poisson)
summary(modeli)
#Carysfort & Tenn
#geno C
#Conch geno B
#Looe Geno C
#Tenn Geno C

modeli <- glm(logmortality ~ reef + genotype, data=healthT_jun, family=poisson)
summary(modeli)
#carysfort & Tenn
modelg <- glm(logmortality ~ genotype, data=healthT_jun, family=poisson)
summary(modelg)
#geno A
modelr <- glm(logmortality ~ reef , data=healthT_jun, family=poisson)
summary(modelr)
#Carysfort & tenne

#fit logistic regression model logalgae
modeli <- glm(logalgae ~ reef * genotype, data=healthT_jun, family=poisson)
summary(modeli)
#NS
modeli <- glm(logalgae ~ reef + genotype, data=healthT_jun, family=poisson)
summary(modeli)
#NS
modelg <- glm(logalgae ~ genotype, data=healthT_jun, family=poisson)
summary(modelg)
#geno A
modelr <- glm(logalgae ~ reef , data=healthT_jun, family=poisson)
summary(modelr)
#NS
```

PCA
PCA does not work for this data= TOO many 0's

`################################################################################
################### Sample plasticity based on PC distances ####################
############## Written by Colleen B. Bove (colleenbove@gmail.com) ##############
########################## Laste update: 10 Jan 2023 ###########################
################################################################################

## Required packages to run:
# dplyr
```{r}


## PC distances can be calculated from prcomp() objects or from plotPCA()


########################################################################################

PCAplast <- function(pca, data, sample_ID = NA, num_pca = "all", control_col, control_lvl = "none", group = NA) {
  
  # rename the user input info
  pca_df <- pca
  data_df <- data
  control_name <- control_col
  control_lvl <- control_lvl
  group_col <- group
  
  # ifelse statement to pull PCs from dataframe or prcomp objects
  if(class(pca_df) == "prcomp"){
    pca_dist <- pca_df$x # grab PC distances from prcomp() object
  } else {
    pca_dist <- pca_df # grab PC distances from data.frame object
  }
  
  
  # check for correct number of PCAs provided
  if(class(num_pca) == "numeric") {
    if(num_pca < 2) { # will throw error if too few PCAs requested
      stop("please select more than 2 PCs to calculate distance")
    } 
  }
  
  if(class(num_pca) == "numeric") {
    if(num_pca > (data.frame(pca_dist) %>% dplyr::select(starts_with("PC")) %>% ncol())) { # will throw error if too many PCAs requested
      stop(paste(num_pca, "PCs requested for calculation, but only", (pca_dist %>% dplyr::select(starts_with("PC")) %>% ncol()), "PCs available. Select appropriate number of PCAs for calculation."))
    } 
  }
  
  
  # oder the dataframe to ensure correct pairing after calculating distance 
  if(sample_ID %in% colnames(data_df)){
    data_df <- data_df[match(row.names(pca_dist), data_df[[sample_ID]]),]
  } else {
    data_df <- data_df[order(as.numeric(row.names(data_df))),]
  }
  
  
  # combine the datasets
  dist_df <- cbind(data_df, pca_dist) 
  
  
  # if there is no control level, modify so function pulls all levels
  if(control_lvl == "none") {
    control_lvl = unique(dist_df[[control_name]])
  } else {
    control_lvl = control_lvl
  }
  
  
  # make dataframe of control grouping only
  if(!is.na(group_col)) { # calculate mean per grouping ID (if provided)
    mean_control <- dist_df %>%
      filter(dist_df[[control_name]] == list(control_lvl)[[1]]) %>% 
      rename_with(tolower) %>% # renames all pc's with lowercase 'PC' (just to differentiate from all sample PCs)
      dplyr::select(colnames((dist_df %>% rename_with(tolower))[tolower(group_col)]), starts_with("pc")) %>%
      group_by_at(vars(tolower(group_col))) %>% 
      summarise_if(is.numeric, mean)
    
    
    # add the control PCA values to treatment samples per grouping
    dist_df2 <- left_join(dist_df, mean_control, by.x = group_col, by.y = tolower(group_col))
    
  } else { # calculate mean per control treatment
    mean_control <- dist_df %>%
      #filter(dist_df[[control_name]] == list(control_lvl)[[1]]) %>% 
      rename_with(tolower) %>% # renames all pc's with lowercase 'PC' (just to differentiate from all sample PCs)
      dplyr::select(colnames((dist_df %>% rename_with(tolower))[tolower(control_name)]), starts_with("pc")) %>% # select just the PCs 
      #group_by() 
      group_by_at(vars(tolower(control_name))) %>% 
      summarise_if(is.numeric, mean)
    
    # add the control PCA values to all samples 
    dist_df2 <- merge(dist_df, mean_control, by.x = control_col, by.y = tolower(control_col), all.x = TRUE)
    
  }
  
  
  
  if(sample_ID %in% colnames(data_df)){
    data_df <- data_df[match(row.names(pca_dist), data_df[[sample_ID]]),]
  } else {
    data_df <- data_df[order(as.numeric(row.names(data_df))),]
  }
  
  
  # again, reorder data
  if(sample_ID %in% colnames(data_df)){
    dist_df2 <- dist_df2[order(dist_df2[[sample_ID]]),]
  } else {
    rownames(dist_df2) <- rownames(data_df)
    dist_df2 <- dist_df2[order(as.numeric(row.names(dist_df2))),]
  }
  
  
  ### Calculate sample (PCA) distances from control (pca) using all PCAs
  # make dataframe to populate with pca distances
  full_calc_dist <- data.frame(control_name = dist_df2[control_name])
  
  if(num_pca == "all") {
    ## forloop that will calculate distances between control and sample for all PCs (n will be total number)
    for(n in 1:(dist_df %>% dplyr::select(starts_with("PC")) %>% ncol())){
      # makes the PCA column name for control (lowercase) and sample (uppercase)
      PC_col <- paste0("PC", n)
      pc_col <- paste0("pc", n)
      
      # pulls the PC column for control (lowercase) and sample (uppercase)
      PCx <- dist_df2[PC_col]
      pcx <- dist_df2[pc_col]
      
      pca_calc_dist <- data.frame((PCx - pcx)^2) # calculates the distance between 2 PCs
      full_calc_dist <- cbind(full_calc_dist, pca_calc_dist) # add that distance to running dataframe
    }
  } else {
    ## forloop that will calculate distances between control and sample for SPECIFIED # of PCs (n will be total number)
    for(n in 1:as.numeric(num_pca)){
      # makes the PC column name for control (lowercase) and sample (uppercase)
      PC_col <- paste0("PC", n)
      pc_col <- paste0("pc", n)
      
      # pulls the PC column for control (lowercase) and sample (uppercase)
      PCx <- dist_df2[PC_col]
      pcx <- dist_df2[pc_col]
      
      pca_calc_dist <- data.frame((PCx - pcx)^2) # calculates the distance between 2 PCs
      full_calc_dist <- cbind(full_calc_dist, pca_calc_dist) # add that distance to running dataframe
    }
  }
  
  
  ## final distance calculation (adds all PCA distances and takes squareroot)
  distance <- full_calc_dist %>% 
    mutate(dis_sum = rowSums(across(where(is.numeric)))) %>% 
    mutate(dist = sqrt(dis_sum)) %>% 
    dplyr::select(matches("dist"))
  
  
  ## combine the calculated distance with the metadata and remove controls for final dataframe
  dist_df <- data_df %>% 
    bind_cols(distance) %>% 
    filter(!is.na(dist)) 
  
  ## removes the control levels
  if(length(control_lvl) > 1){
    dist_df <- dist_df
  } else {
    dist_df <- dist_df %>%
      filter(dist_df[[control_name]] != control_lvl)  %>% 
      droplevels()
  }
  
}

library(vegan)
library(factoextra)
library(corrplot)
library(ggfortify)
library(devtools)
# set up the dataframe
PCDF<-healthT_jun[c(5:8,15:18,20)]
head(PCDF)
PCDF<-PCDF%>%drop_na()
PCDFaug<-subset(PCDF, time=="4")
head(PCDFaug)

datapca<-PCDFaug[1:4]
head(datapca)

reef_pca_df <- PCDFaug[5:9]
head(reef_pca_df)
### too many simul

# perform principal component analysis (PCA)
sr_pca <- prcomp(reef_pca_df, center = TRUE, scale= TRUE)
sr_pca

autoplot(sr_pca, data=datapca, color= "reef")
#
## To run the function, enter the following objects:

 PCAplast(pca = sr_pca, # the PCA dataframe containing the PCA eigenvalues
          data = datapca, # the condition/treatment data corresponding to samples
          sample_ID = "coral_id", # the name of column that provide unique ID per sample (if blank, will pull rownames for this)
          #num_pca =  "XXX", # the number of PCAs to include in analysis (default is 'all', but you can specify another number with a minimum of 2 PCAs)
          control_col = "reef", # what the 'treatment' column is called
          control_lvl = "Conch", # control level of the treatment. If blank, a control mean per control level is assumed
          group = "genotype") # the grouping column (i.e., colony). If blank, will assume control level grouping only!

 
```


```{r}
library(vegan)
library(factoextra)
library(corrplot)
library(ggfortify)
library(devtools)
# set up the dataframe
PCDF<-healthT_jun[c(5:8, 12, 15:18,20)]
head(PCDF)
PCA_l <- gather(PCDF, param, value, 5:10)
head(PCA_l)
reef_pca_df <- PCDF[5:10]

# run the adonis
s_pca_mod <- adonis2(reef_pca_df ~ SITE, data = enviorpca, method = 'eu', permutations = bootnum)
s_pca_mod # view  adonis output
summary(s_pca_mod)
# extract pvalues
s_pval <- s_pca_mod["Pr(>F)"]
# perform principal component analysis (PCA)
s_pca <- prcomp(reef_pca_df, center = TRUE, scale= TRUE)
s_pca
attributes(s_pca)
s_pca$scale
print(s_pca)
#PC1 increases when TN, Sal, Kd, TN:TP, & O2 sat increase (positively correlated)
#PC1 increases when TP, CHla, TOC, & temp decrease (negatively correlated)
summary(s_pca)
#calculate total variance explained by each principal component
s_pca$sdev^2 / sum(s_pca$sdev^2)
```

Non-parametric
```{r}
setwd("C:/Github/Orbicella_FL/Graphs/health")

######################################
res.kruskali <- healthT_jun %>% kruskal_test(algae_growth ~ reef)
res.kruskali
#1.45e-10
pwci <- healthT_jun %>% 
  dunn_test(algae_growth ~ reef, p.adjust.method = "BH") 
pwci
# Cary- Tenn
#Conch-Tenn
#Looe-Tenn
pwci <- pwci %>% add_xy_position(x = "treatment")

algae_reef<-ggboxplot(healthT_jun, x = "reef", y = "algae_growth", color= "black", fill="reef", outlier.shape = 1) +
  stat_boxplot(geom='errorbar', linetype=1, width=0.5)+  #whiskers
  ylab("Algae overgrowth (%)")+
  xlab('Treatment')+
   theme(legend.position = "none")+
 scale_fill_manual(values =colors2)+
  stat_summary(fun=mean, geom="point", size=2)+ #line is median, and closed circle is mean
  scale_x_discrete(breaks=c("Ti","T1", "T2", "T3", "Tc"),
        labels=c("Inital","Sprinkler", "Feeding", "Interactive","Control"))+
   stat_pvalue_manual(pwci, hide.ns = TRUE) +
    labs(
    subtitle = get_test_label(res.kruskali, detailed = TRUE),
    caption = get_pwc_label(pwci)
    )

algae_reef

ggexport(algae_reef, filename = "algae_reef.pdf")
```

```{r}

data_long <- gather(healthT_jun, condition, value, mortality:white, factor_key=TRUE)
data_long

str(data_long)

feb<-subset(data_long, time=="0")
may<-subset(data_long, time=="1")
aug<-subset(data_long, time=="2")
dec<-subset(data_long, time=="3")
#jun<-subset(data_long, time=="4")

febM<-subset(healthT_jun, time=="0")
mayM<-subset(healthT_jun, time=="1")
augM<-subset(healthT_jun, time=="2")
decM<-subset(healthT_jun, time=="3")

ggplot(data_long, aes(fill=condition, y=value, x=reef)) + 
    geom_bar(position="fill", stat="identity") +
    ggtitle("") +
    facet_wrap(~genotype) +
    ylab("Percent of total tissue (%)")+
  xlab("")



#################################  mortality Overall
#Reef
res.kruskal2 <- healthT_jun %>% kruskal_test(mortality ~ reef)
res.kruskal2
#0.00575 stat=12.5
pwcCP <- healthT_jun %>% 
  dunn_test(mortality ~ reef, p.adjust.method = "bonferroni") 
pwcCP

#1 mortality Cary   Conch        63    59     0.507 0.612    1       ns          
#2 mortality Cary   Looe         63    62     1.32  0.188    1       ns          
#3 mortality Cary   Tennessee    63    47     3.35  0.000813 0.00488 **          
#4 mortality Conch  Looe         59    62     0.791 0.429    1       ns          
#5 mortality Conch  Tennessee    59    47     2.83  0.00464  0.0278  *           
#6 mortality Looe   Tennessee    62    47     2.12  0.0342   0.205   ns


# Genotype
res.kruskal2 <- healthT_jun %>% kruskal_test(mortality ~ genotype)
res.kruskal2
#0.561 stat=2.06
pwcCP <- healthT_jun %>% 
  dunn_test(mortality ~ genotype, p.adjust.method = "bonferroni") 
pwcCP

#cat
res.kruskal2 <- healthT_jun %>% kruskal_test(mortality ~ cat)
res.kruskal2
#0.042 stat=25.06
pwcCP <- healthT_jun %>% 
  dunn_test(mortality ~ cat, p.adjust.method = "bonferroni") 
pwcCP
# just global No post-hoc

res.kruskal2 <- healthT_jun %>% kruskal_test(mortality ~ reef)
res.kruskal2
#0.00575 stat=12.5
pwcCP <- healthT_jun %>% 
  dunn_test(mortality ~ reef, p.adjust.method = "bonferroni") 
pwcCP

#################################  mortality through time
res.kruskal2 <- febM %>% kruskal_test(mortality ~ reef)
res.kruskal2
#Na
res.kruskal2 <- febM %>% kruskal_test(mortality ~ genotype)
res.kruskal2
#NA
res.kruskal2 <- mayM %>% kruskal_test(mortality ~ reef)
res.kruskal2
#0.265 stat=3.97
pwcCP <- mayM %>% 
  dunn_test(mortality ~ reef, p.adjust.method = "bonferroni") 
pwcCP
res.kruskal2 <- mayM %>% kruskal_test(mortality ~ genotype)
res.kruskal2
#0.732 stat=1.29


#################################
res.kruskal2 <- augM %>% kruskal_test(mortality ~ reef)
res.kruskal2
#0.000346 stat=18.5
pwcCP <- augM %>% 
  dunn_test(mortality ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 mortality Cary   Conch        16    14    -1.19  0.234     1        ns          
#2 mortality Cary   Looe         16    16     0.568 0.570     1        ns          
#3 mortality Cary   Tennessee    16    15     3.07  0.00213   0.0128   *           
#4 mortality Conch  Looe         14    16     1.74  0.0823    0.494    ns          
#5 mortality Conch  Tennessee    14    15     4.14  0.0000345 0.000207 ***         
#6 mortality Looe   Tennessee    16    15     2.51  0.0120    0.0718   ns

augM %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))


res.kruskal2 <- augM %>% kruskal_test(mortality ~ genotype)
res.kruskal2
#0.49 stat=2.42

#################################

res.kruskal2 <- decM %>% kruskal_test(mortality ~ reef)
res.kruskal2
#0.0905 stat=4.80
pwcCP <- decM %>% 
  dunn_test(mortality ~ reef, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal2 <- decM %>% kruskal_test(mortality ~ genotype)
res.kruskal2
#0.714 stat=1.37
res.kruskal2 <- decM %>% kruskal_test(mortality ~ monrang)
res.kruskal2
#0.0905 stat=4.80

######################### graphing
colors2 <-  thematic::okabe_ito(4)

ggboxplot(healthT_jun, x = "reef", y = "mortality", 
          color = "reef",
          ylab = "Dead tissue (%)", xlab = "")

ggline(healthT_jun, x = "time", y = "mortality", 
       add = c("mean_se", "jitter"),
       color = "reef",
       facet.by = "reef",
       ylab = "Dead tissue (%)", xlab = "")

library(Rmisc)

mort1<-group_by(healthT_jun, reef, time) %>%
  dplyr::summarise(
    count = n(),
    mean = mean(mortality, na.rm = TRUE),
    sd = sd(mortality, na.rm = TRUE),
    median = median(mortality, na.rm = TRUE))
mort1

mort<-healthT_jun %>%
  group_by(reef, time) %>%
  dplyr::summarise(mean = mean(mortality, na.rm = TRUE),
            sd = sd(mortality, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
mort

### 95% CI error bars of meanmortality at each timepoint

ggplot(mort, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=lower.ci, ymax=upper.ci), width=.1) +
    geom_line() +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Dead Tissue (%)")+
  xlab("")
  
################### with SE bars
setwd("C:/Github/Orbicella_FL/Graphs/health")

Mortplot<-ggplot(mort, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Dead Tissue (%)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
Mortplot 
ggexport(Mortplot, filename = "Mortplot.pdf")

################################# healthy tissue

res.kruskal2 <- healthT_jun %>% kruskal_test(healthy_tissue ~ reef)
res.kruskal2
#0.351 stat=3.27
pwcCP <- healthT_jun %>% 
  dunn_test(healthy_tissue ~ reef, p.adjust.method = "bonferroni") 
pwcCP
res.kruskal2 <- healthT_jun %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskal2
#0.872 stat=.706

#cat
res.kruskal2 <- healthT_jun %>% kruskal_test(healthy_tissue ~ cat)
res.kruskal2
#0.87 stat=9.14


#################################  healthy tissue through time
res.kruskal2 <- febM %>% kruskal_test(healthy_tissue ~ reef)
res.kruskal2
#Na
res.kruskal2 <- febM %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskal2
#NA
res.kruskal2 <- mayM %>% kruskal_test(healthy_tissue ~ reef)
res.kruskal2
#0.12 stat=5.83
res.kruskal2 <- mayM %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskal2
#0.679 stat=1.51
res.kruskal2b <- augM %>% kruskal_test(healthy_tissue ~ reef)
res.kruskal2
#0.000225 stat=19.4
pwcCP <- augM %>% 
  dunn_test(healthy_tissue ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 healthy_tissue Cary   Conch        16    14     3.29  0.000985  0.00591  **          
#2 healthy_tissue Cary   Looe         16    16     0.315 0.752     1        ns          
#3 healthy_tissue Cary   Tennessee    16    13    -1.05  0.296     1        ns          
#4 healthy_tissue Conch  Looe         14    16    -2.99  0.00279   0.0167   *           
#5 healthy_tissue Conch  Tennessee    14    13    -4.14  0.0000340 0.000204 ***         
#6 healthy_tissue Looe   Tennessee    16    13    -1.34  0.179     1        ns 
augM %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))


res.kruskal2 <- augM %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskal2
#0.574 stat=1.99

res.kruskal2 <- decM %>% kruskal_test(healthy_tissue ~ reef)
res.kruskal2
#0.0000118 
pwcCP <- decM %>% 
  dunn_test(healthy_tissue ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#cary- conch
#cary looe
########################### recovery from Aug- Dec
recover<-rbind(augM,decM)
head(recover)  
R2<-recover %>% group_by(reef, time) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
R2 


write.csv(R3,"C:/Github/Orbicella_FL/R_dataOutput/R3.csv")

setwd("C:/Github/Orbicella_FL/Raw Data")
recovery <- read.csv("Raw_recovery.csv")

R3<-recovery %>% group_by(reef) %>% dplyr::summarise(n = n(), mean = mean(diffH, na.rm=TRUE), sd = sd(diffH, na.rm=TRUE))
R3

####### statistical comparison of differences in tissue health (%) from Aug-Dec
#############healthy tissue
R3<-recovery %>% group_by(reef) %>% dplyr::summarise(n = n(), mean = mean(diffH, na.rm=TRUE), sd = sd(diffH, na.rm=TRUE))
R3

res.kruskal2 <- recovery %>% kruskal_test(diffH ~ reef)
res.kruskal2
#0.00000674
pwcCP <- recovery %>% 
  dunn_test(diffH ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#cary-Conch- 0.0000110
#Conch-Looe 0.000691

#############white tissue
recovery %>% group_by(reef) %>% dplyr::summarise(n = n(), mean = mean(diffW, na.rm=TRUE), sd = sd(diffW, na.rm=TRUE))

res.kruskal2 <- recovery %>% kruskal_test(diffW ~ reef)
res.kruskal2
#0.00000845
pwcCP <- recovery %>% 
  dunn_test(diffW ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#cary-Conch 0.0000100
#Conch-Looe 0.00138
#############pale tissue
recovery %>% group_by(reef) %>% dplyr::summarise(n = n(), mean = mean(diffP, na.rm=TRUE), sd = sd(diffP, na.rm=TRUE))

res.kruskal2 <- recovery %>% kruskal_test(diffP ~ reef)
res.kruskal2
#0.00000542 
pwcCP <- recovery %>% 
  dunn_test(diffP ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#cary-Conch 0.0000228
#Conch-Looe 0.000158
############# tissue mortality
recovery %>% group_by(reef) %>% dplyr::summarise(n = n(), mean = mean(diffM, na.rm=TRUE), sd = sd(diffM, na.rm=TRUE))

res.kruskal2 <- recovery %>% kruskal_test(diffM ~ reef)
res.kruskal2
#0.0312 
pwcCP <- recovery %>% 
  dunn_test(diffM ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#Conch-Looe 0.0475
########################## subset differences between times
Rcary<-subset(recover, reef=="Cary")
Rconc<-subset(recover, reef=="Conch")
Rlooe<-subset(recover, reef=="Looe")
RTenn<-subset(recover, reef=="Tennessee")

Rcary%>% group_by( reef,time) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
# 77.8-99.1= 21.3%
res.kruskal2 <- Rcary %>% kruskal_test(healthy_tissue ~ time)
res.kruskal2
#0.00000569
pwcCP <- Rcary %>% 
  dunn_test(healthy_tissue ~ time, p.adjust.method = "bonferroni") 
pwcCP
## 2-3 
Rconc%>% group_by(reef, time) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
#96.6-81.3= 15.3%
res.kruskal2 <- Rconc %>% kruskal_test(healthy_tissue ~ time)
res.kruskal2
#0.000877
pwcCP <- Rconc %>% 
  dunn_test(healthy_tissue ~ time, p.adjust.method = "bonferroni") 
pwcCP
#2-3
Rlooe%>% group_by(reef, time) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
#69.8-94.6= 24.8%
res.kruskal2 <- Rlooe %>% kruskal_test(healthy_tissue ~ time)
res.kruskal2
#0.0282
pwcCP <- Rlooe %>% 
  dunn_test(healthy_tissue ~ time, p.adjust.method = "bonferroni") 
pwcCP
#2-3

###################################
res.kruskal2 <- decM %>% kruskal_test(healthy_tissue ~ reef)
res.kruskal2
#0.0000118 stat=22.7
pwcCP <- decM %>% 
  dunn_test(healthy_tissue ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 healthy_tissue Cary   Conch     15    14     -4.75 0.00000201 0.00000602 ****        
#2 healthy_tissue Cary   Looe      15    14     -2.57 0.0101     0.0304     *           
#3 healthy_tissue Conch  Looe      14    14      2.15 0.0319     0.0958     ns 
decM %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

res.kruskal2 <- decM %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskal2
#0.733 stat=1.28

heat<-healthT_jun %>%
  group_by(reef, time) %>%
  dplyr::summarise(mean = mean(healthy_tissue, na.rm = TRUE),
            sd = sd(healthy_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
heat

################################# Graphing
heatplot<-ggplot(heat, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy Tissue (%)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
heatplot 
ggexport(heatplot, filename = "heatplot.pdf")

#################################  white tissue
res.kruskal2 <- healthT_jun %>% kruskal_test(white ~ reef)
res.kruskal2
#0.619 stat= 1.78
pwcCP <- healthT_jun %>% 
  dunn_test(white ~ reef, p.adjust.method = "bonferroni") 
pwcCP
res.kruskal2 <- healthT_jun %>% kruskal_test(white ~ genotype)
res.kruskal2
#.6 stat=1.87

#cat
res.kruskal2 <- healthT_jun %>% kruskal_test(white ~ cat)
res.kruskal2
#0.887 stat=8.82

#################################  mortality through time
res.kruskal2 <- febM %>% kruskal_test(white ~ reef)
res.kruskal2
#Na
res.kruskal2 <- febM %>% kruskal_test(white ~ genotype)
res.kruskal2
#NA
res.kruskal2 <- mayM %>% kruskal_test(white ~ reef)
res.kruskal2
#0.166 stat=5.08
res.kruskal2 <- mayM %>% kruskal_test(white ~ genotype)
res.kruskal2
#0.339 stat=3.37
res.kruskal2 <- augM %>% kruskal_test(white ~ reef)
res.kruskal2
#0.000434 stat=18
pwcCP <- augM %>% 
  dunn_test(white ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 white Cary   Conch        16    14    -3.92  0.0000883 0.000530 ***         
#2 white Cary   Looe         16    16    -0.482 0.630     1        ns          
#3 white Cary   Tennessee    16    12    -1.09  0.275     1        ns          
#4 white Conch  Looe         14    16     3.45  0.000551  0.00331  **          
#5 white Conch  Tennessee    14    12     2.59  0.00969   0.0582   ns          
#6 white Looe   Tennessee    16    12    -0.646 0.518     1        ns 


res.kruskal2 <- augM %>% kruskal_test(white ~ genotype)
res.kruskal2
#0.154 stat=5.26

res.kruskal2 <- decM %>% kruskal_test(white ~ reef)
res.kruskal2
#0.000008288 stat=23.4
pwcCP <- decM %>% 
  dunn_test(white ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 white Cary   Conch     15    14      4.81 0.00000149 0.00000446 ****        
#2 white Cary   Looe      15    14      2.75 0.00593    0.0178     *           
#3 white Conch  Looe      14    14     -2.03 0.0427     0.128      ns   
res.kruskal2 <- decM %>% kruskal_test(white ~ monrang)
res.kruskal2

res.kruskal2 <- decM %>% kruskal_test(white ~ genotype)
res.kruskal2
#0.628 stat=1.74

white<-healthT_jun %>%
  group_by(reef, time) %>%
  dplyr::summarise(mean = mean(white, na.rm = TRUE),
            sd = sd(white, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
white

#################################Graphing
whiteplot<-ggplot(white, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Bleached Tissue (%)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
whiteplot 
ggexport(whiteplot, filename = "whiteplot.pdf")

#######

ggplot(feb, aes(fill=condition, y=value, x=reef)) + 
    geom_bar(position="fill", stat="identity") +
    ggtitle("") +
    facet_wrap(~genotype) +
    ylab("Percent of total tissue (%)")+
    theme_classic()+
  xlab("")

ggplot(may, aes(fill=condition, y=value, x=reef)) + 
    geom_bar(position="fill", stat="identity") +
    ggtitle("") +
    facet_wrap(~genotype) +
    ylab("Percent of total tissue (%)")+
  theme_classic()+
  xlab("")

ggplot(aug, aes(fill=condition, y=value, x=reef)) + 
    geom_bar(position="fill", stat="identity") +
    ggtitle("") +
    facet_wrap(~genotype) +
    ylab("Percent of total tissue (%)")+
    theme_classic()+
  xlab("")

ggplot(dec, aes(fill=condition, y=value, x=reef)) + 
    geom_bar(position="fill", stat="identity") +
    ggtitle("") +
    facet_wrap(~genotype) +
    ylab("Percent of total tissue (%)")+
    theme_classic()+
  xlab("")

ggplot(jun, aes(fill=condition, y=value, x=reef)) + 
    geom_bar(position="fill", stat="identity") +
    ggtitle("") +
    facet_wrap(~genotype) +
    ylab("Percent of total tissue (%)")+
    theme_classic()+
  xlab("")
```

```{r}
#mortality includes algae cover, white is just bleached, and healthy is live tissue
#remove NAs from dataframe
healthN<-healthT_jun
#healthTN<-na.omit(healthT)

#Merge monthly mean with Time to compare across both time and monthly temp
#healthTN$x <- paste(healthTN$time,healthTN$reef,healthTN$monmean)
#healthTN$x
#31 observations (missing corals)

#healthclean<-na.omit(healthN)


#healthclean$healthy_y_n<-ifelse(healthclean$healthy_y_n=="Yes",1,0)
#healthN
write.csv(healthN,"C:/Github/Orbicella_FL/R_dataOutput/healthN.csv")


healthN <- healthN %>%
      mutate(healthy_y_n = ifelse(healthy_y_n == "no",0,1))

healthN <- healthN %>%
      mutate(blotchy_y_n = ifelse(blotchy_y_n == "no",0,1))

healthN <- healthN %>%
          mutate  (disease_y_n = ifelse(disease_y_n == "no",0,1))

healthN <- healthN %>%
           mutate  (tumor_y_n= ifelse(tumor_y_n == "no",0,1))
             
healthN <- healthN %>%
           mutate  (boring_y_n= ifelse(boring_y_n == "no",0,1))
#############

data_long2 <- gather(healthN, condition, value, c(mortality, healthy_tissue, white), factor_key=TRUE)
data_long2

feb2<-subset(data_long2, time=="0")
may2<-subset(data_long2, time=="1")
aug2<-subset(data_long2, time=="2")
dec2<-subset(data_long2, time=="3")
#jun2<-subset(data_long2, time=="4")

#ggplot(data_long2, aes(fill=condition, y=value, x=coral_id)) + 
#    geom_bar(position="stack", stat="identity")+
#    ggtitle("") +
#    facet_wrap(~reef, scales="free") +
#  theme_classic()+
#  ylab("Percent (%)")+
#    xlab("")

library(thematic)
# Color-blind safe colors
colors <-  thematic::okabe_ito(3)
# Possible levels of transparency (one for each class)
alpha_max <- 1
alpha_min <- 0.2
alpha_vals <- c(
  seq(alpha_max, alpha_min, length.out = 4), 
  seq(alpha_min, alpha_max, length.out = 4)[-1]
)
alpha_vals

setwd("C:/Github/Orbicella_FL/Graphs/health")



AvgHplot<-ggplot(data_long2, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
  scale_fill_manual(values = colors) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue(%)")+
    xlab("")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  ggtitle("Overall Health")

AvgHplot
ggexport(AvgHplot, filename = "AvgHplot.pdf")


data_long2b <- gather(healthN, condition, value, c(mortality, healthy_tissue, white, algae_growth, pale_living_tissue), factor_key=TRUE)
data_long2b

AvgHplotb<-ggplot(data_long2b, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
  scale_fill_manual(values = colors3) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue (%)")+
    xlab("")+
  #scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  ggtitle("Overall Health")+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

AvgHplotb
ggexport(AvgHplotb, filename = "AvgHplotbp2.pdf")

AvgHplotb2<-ggplot(data_long2b, aes(fill=condition, y=value, x=reef, alpha= reef)) + 
    geom_bar(position="stack", stat="identity")+
    ggtitle("") +
    facet_wrap(~genotype, scales="free") +
  theme_classic()+
  scale_fill_manual(values = colors3) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue(%)")+
    xlab("")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  ggtitle("Overall Health")+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

AvgHplotb2
ggexport(AvgHplotb2, filename = "AvgHplotbp2g.pdf")
##################################################################### Algae overgrowth
data_long2ba <- gather(healthN, condition, value, c(algae_growth), factor_key=TRUE)
data_long2ba

col= "#009E73"
feb2b<-subset(data_long2ba, time=="0")
may2b<-subset(data_long2ba, time=="1")
aug2b<-subset(data_long2ba, time=="2")
dec2b<-subset(data_long2ba, time=="3")
#jun2b<-subset(data_long2ba, time=="4")

AugHplot<-ggplot(aug2b, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("August 2019")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#009E73"))

AugHplot
ggexport(AugHplot, filename = "AugHplotAlgae2.pdf")

AugHplot2<-ggplot(aug2b, aes(fill=condition, y=value, x=reef, alpha= reef)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~genotype) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("August 2019")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#009E73"))+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

AugHplot2
ggexport(AugHplot2, filename = "AugHplotAlgae2.pdf")

#JunHplot<-ggplot(jun2b, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
#    geom_bar(position="stack", stat="identity", colour= "black")+
#    ggtitle("") +
#    facet_wrap(~reef) +
#  theme_classic()+
#   scale_fill_manual(values = col) +
#  scale_alpha_manual(values = alpha_vals)+
#  ylab("Percent tissue condition(%)")+
#    xlab("")+
#  ggtitle("June 2021")+
#   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
#  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
#  theme(strip.background = element_rect(color= "black", fill="#F0E442"))
#
#JunHplot
#ggexport(JunHplot, filename = "JunHplottAlgae.pdf")
#
#JunHplot2<-ggplot(jun2b, aes(fill=condition, y=value, x=reef, alpha= reef)) + 
#    geom_bar(position="stack", stat="identity", colour= "black")+
#    ggtitle("") +
#    facet_wrap(~genotype) +
#  theme_classic()+
#   scale_fill_manual(values = col) +
#  scale_alpha_manual(values = alpha_vals)+
#  ylab("Percent tissue condition(%)")+
#    xlab("")+
#  ggtitle("Junust 2019")+
#   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
#  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
#  theme(strip.background = element_rect(color= "black", fill="#009E73"))+
#  theme(axis.text = element_text(size = 13))+
#  theme(axis.title = element_text(size = 14))
#
#JunHplot2
#ggexport(JunHplot2, filename = "JunHplotAlgae2.pdf")

################################################################# 
data_long2bp <- gather(healthN, condition, value, c(pale_living_tissue), factor_key=TRUE)
data_long2bp

col= "gray"
feb2bp<-subset(data_long2bp, time=="0")
may2bp<-subset(data_long2bp, time=="1")
aug2bp<-subset(data_long2bp, time=="2")
dec2bp<-subset(data_long2bp, time=="3")
#jun2bp<-subset(data_long2bp, time=="4")

AugHplot<-ggplot(aug2bp, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("August 2019")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#009E73"))

AugHplot
ggexport(AugHplot, filename = "AugHplotpale2.pdf")

AugHplot2<-ggplot(aug2bp, aes(fill=condition, y=value, x=reef, alpha= reef)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~genotype) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("August 2019")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#009E73"))+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

AugHplot2
ggexport(AugHplot2, filename = "AugHplotpale2.pdf")

DecHplot<-ggplot(dec2bp, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("December 2019 ")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#56B4E9"))

DecHplot
ggexport(DecHplot, filename = "DecHplotpale2.pdf")

DecHplot2<-ggplot(dec2bp, aes(fill=condition, y=value, x=reef, alpha= reef)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~genotype) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("December 2019 ")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#56B4E9"))+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

DecHplot2
ggexport(DecHplot2, filename = "DecHplotpale2.pdf")

#JunHplot<-ggplot(jun2bp, aes(fill=condition, y=value, x=genotype, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("June 2021")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#F0E442"))

#JunHplot
#ggexport(JunHplot, filename = "JunHplottpale.pdf")

#JunHplot2<-ggplot(jun2bp, aes(fill=condition, y=value, x=reef, alpha= reef)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~genotype) +
  theme_classic()+
   scale_fill_manual(values = col) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Percent tissue condition(%)")+
    xlab("")+
  ggtitle("June 2021")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#F0E442"))+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

#JunHplot2
#ggexport(JunHplot2, filename = "JunHplottpale2.pdf")



FebHplot<-ggplot(feb2, aes(fill=condition, y=value, x=coral_id, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
  scale_fill_manual(values = colors) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue(%)")+
    xlab("")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  ggtitle("February 2019 Health")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  theme(strip.background = element_rect(color= "black", fill="#CC79A7"))

FebHplot
ggexport(FebHplot, filename = "FebHplot2.pdf")

MayHplot<-ggplot(may2, aes(fill=condition, y=value, x=coral_id, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
   scale_fill_manual(values = colors) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue(%)")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  xlab("")+
  ggtitle("May 2019 Health")+
  # theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  theme(strip.background = element_rect(color= "black", fill="#D55E00"))

MayHplot
ggexport(MayHplot, filename = "MayHplot2.pdf")


AugHplot<-ggplot(aug2, aes(fill=condition, y=value, x=coral_id, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
   scale_fill_manual(values = colors) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue(%)")+
    xlab("")+
  ggtitle("August 2019 Health")+
   #theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#009E73"))

AugHplot
ggexport(AugHplot, filename = "AugHplot2.pdf")

DecHplot<-ggplot(dec2, aes(fill=condition, y=value, x=coral_id, alpha= genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
   scale_fill_manual(values = colors) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue(%)")+
    xlab("")+
  ggtitle("December 2019 Health")+
   scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  theme(strip.background = element_rect(color= "black", fill="#56B4E9"))

DecHplot
ggexport(DecHplot, filename = "DecHplot2.pdf")

#JunHplot<-ggplot(jun2, aes(fill=condition, y=value, x=coral_id, alpha=genotype)) + 
    geom_bar(position="stack", stat="identity", colour= "black")+
    ggtitle("") +
    facet_wrap(~reef, scales="free") +
  theme_classic()+
   scale_fill_manual(values = colors) +
  scale_alpha_manual(values = alpha_vals)+
  ylab("Total percent tissue(%)")+
    xlab("")+
  ggtitle("June 2021 Health")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(strip.background = element_rect(color= "black", fill="#F0E442"))
#JunHplot
#ggexport(JunHplot, filename = "JunHplot.pdf")


grid.arrange(FebHplot, MayHplot, AugHplot, DecHplot, JunHplot, ncol=3)

### binomal data set

data_longB <- gather(healthN, condition, value, c( blotchy_y_n, disease_y_n , tumor_y_n, boring_y_n),factor_key=TRUE)

str(data_longB)

data_longB$value<-as.factor(data_longB$value)

febB<-subset(data_longB, time=="0")
mayB<-subset(data_longB, time=="1")
augB<-subset(data_longB, time=="2")
decB<-subset(data_longB, time=="3")
#junB<-subset(data_longB, time=="4")

#my_dataframe <- my_dataframe %>% rename("healthy_y_n" = "Healthy",
    #                                   "blotchy_y_n" = "Blotchy",
    #                                   "disease_y_n" = "Disease",
    #                                   "tumor_y_n" = "Tumor",
    #                                   "boring_y_n" = "Boring")



FebCplot<-ggplot(febB, aes(coral_id, condition, fill = value, alpha= genotype)) + geom_tile(color = "black") +
  facet_grid(.~reef, scale="free") +
   theme_classic()+
  scale_fill_manual(values = colors, labels = c("No", "Yes"))+
     scale_alpha_manual(values = alpha_vals)+
    ylab("")+
    xlab("")+
  ggtitle("February 2019 Coral Condition")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  theme(strip.background = element_rect(color= "black", fill="#CC79A7"))

FebCplot
ggexport(FebCplot, filename = "FebCplot2h.pdf")

 
MayCplot<-ggplot(mayB, aes(coral_id, condition, fill = value, alpha=genotype)) + geom_tile(color = "black") +
  facet_grid(.~reef, scale="free") +
     theme_classic()+
  scale_fill_manual(values = colors, labels = c("No", "Yes"))+
    scale_alpha_manual(values = alpha_vals)+
  ylab("")+
    xlab("")+
  ggtitle("May 2019 Coral Condition")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
 theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
 theme(strip.background = element_rect(color= "black", fill="#D55E00"))

MayCplot
ggexport(MayCplot, filename = "MayCplot2h.pdf")

AugCplot<-ggplot(augB, aes(coral_id, condition, fill = value, alpha= genotype)) + geom_tile(color = "black") +
  facet_grid(.~reef, scale="free") +
     theme_classic()+
  scale_fill_manual(values = colors, labels = c("No", "Yes"))+
    scale_alpha_manual(values = alpha_vals)+
      ylab("")+
    xlab("")+
  ggtitle("August 2019 Coral Condition")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
  theme(strip.background = element_rect(color= "black", fill="#009E73"))
AugCplot
ggexport(AugCplot, filename = "AugCplot2h.pdf")

DecCplot<-ggplot(decB, aes(coral_id, condition, fill = value, alpha=genotype)) + geom_tile(color = "black") +
  facet_grid(.~reef, scale="free") +
     theme_classic()+
  scale_fill_manual(values = colors, labels = c("No", "Yes"))+
    scale_alpha_manual(values = alpha_vals)+
      ylab("")+
    xlab("")+
  ggtitle("December 2019 Coral Condition")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  theme(axis.text.x = element_text(angle = 70, size = 8 , vjust = 0.5))+
theme(strip.background = element_rect(color= "black", fill="#56B4E9"))
DecCplot
ggexport(DecCplot, filename = "DecCplot2h.pdf")

#JunCplot<-ggplot(junB, aes(coral_id, condition, fill = value, alpha=genotype)) + geom_tile(color = "black") +
#  facet_grid(.~reef, scale="free") +
#     theme_classic()+
#  scale_fill_manual(values = colors, labels = c("No", "Yes"))+
#    scale_alpha_manual(values = alpha_vals)+
#       ylab("")+
#    xlab("")+
#  ggtitle("June 2021 Coral Condition")+
#  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
#  theme(strip.background = element_rect(color= "black", fill="#F0E442"))
#JunCplot
#ggexport(JunCplot, filename = "JunCplot.pdf")

grid.arrange(FebCplot, MayCplot, AugCplot, DecCplot, JunCplot, ncol=3)



```


```{r}
library(car)
scatterplotMatrix(health[7:10])
```

Shapiro-Wilk Test for Multivariate Normality
https://universeofdatascience.com/shapiro-wilk-test-for-univariate-and-multivariate-normality-in-r/
We use mshapiro.test() function available in mvnormtest package (Jarek, 2012).

reef and genotype affect- health parameters
Not normal data
```{r}
#Checking univariate normality for each combination of independent and dependent variables
library(rstatix)
healthN %>% group_by(genotype) %>% shapiro_test(algae_growth , mortality, white, pale_living_tissue)

#Does not meet assumptions of multivariate normality

# Multivariate normality test
library(mvnormalTest)
mardia(healthN[, c("algae_growth" , "mortality", "white","pale_living_tissue")])$mv.test

#          Test Statistic p-value Result
#1     Skewness 2599.9067       0     NO
#2     Kurtosis  109.5627       0     NO
#3 MV Normality      <NA>    <NA>     NO

library(heplots)

boxM(Y = healthN[, c("algae_growth" , "mortality", "white","pale_living_tissue")], group = healthN$reef)
#	Box's M-test for Homogeneity of Covariance Matrices
#
#data:  health[, c("algae_growth", "mortality", "white")]
#Chi-Sq (approx.) = Inf, df = 18, p-value < 2.2e-16

boxM(Y = healthN[, c("algae_growth" , "mortality", "white","pale_living_tissue")], group = healthN$genotype)
#Box's M-test for Homogeneity of Covariance Matrices
#
#data:  health[, c("algae_growth", "mortality", "white")]
#Chi-Sq (approx.) = 142.63, df = 18, p-value < 2.2e-16

```

```{r}
healthD <- within(healthN, reef <- relevel(reef, ref = 2))
head(healthD)
```

Subset data for mean comparisons at each survey time 
```{r}
febP<-subset(healthD, time=="0")
mayP<-subset(healthD, time=="1")
augP<-subset(healthD, time=="2")
decP<-subset(healthD, time=="3")
#junP<-subset(healthD, time=="4")
```

All means

```{r}
healthD %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthD %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthD %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthD %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthD %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthD %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthD %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthD %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthD %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthD %>% group_by(reef, monmean, time) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

res.kruskal2 <- healthD %>% kruskal_test(algae_growth ~ reef)
res.kruskal2
pwcCP <- healthD %>% 
  dunn_test(algae_growth ~ reef, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal2 <- healthD %>% kruskal_test(mortality ~ reef)
res.kruskal2
pwcCP <- healthD %>% 
  dunn_test(mortality ~ reef, p.adjust.method = "bonferroni") 
pwcCP


res.kruskal2 <- healthD %>% kruskal_test(healthy_tissue ~ reef)
res.kruskal2
res.kruskal2 <- healthD %>% kruskal_test(white ~ reef)
res.kruskal2
res.kruskal2 <- healthD %>% kruskal_test(pale_living_tissue ~ reef)
res.kruskal2

```

https://www.reneshbedre.com/blog/manova.html#:~:text=If%20you%20have%20more%20than,ANOVA%20for%20each%20dependent%20variable.



summary statistics %Algae_growth
```{r}
# summary statistics for dependent variable algae_growth 
healthD %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthD %>% group_by(genotype) %>%  dplyr::summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthD %>% group_by(time) %>%  dplyr::summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthD %>% group_by(salinity) %>%  dplyr::summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthD %>% group_by(temp) %>%  dplyr::summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

healthD %>% group_by(time, reef,monrang) %>% dplyr:: summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))
```

algae comparisons
```{r}
#################################  algae tissue
res.kruskal2 <- healthD %>% kruskal_test(algae_growth ~ reef)
res.kruskal2
#1.45e-10 stat= 48.8
pwcCP <- healthD %>% 
  dunn_test(algae_growth ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 algae_growth Conch  Cary         59    63     0     1             1            ns          
#2 algae_growth Conch  Looe         59    62     0.350 0.727         1            ns          
#3 algae_growth Conch  Tennessee    59    47     5.94  0.00000000288 0.0000000173 ****        
#4 algae_growth Cary   Looe         63    62     0.356 0.722         1            ns          
#5 algae_growth Cary   Tennessee    63    47     6.02  0.00000000171 0.0000000102 ****        
#6 algae_growth Looe   Tennessee    62    47     5.67  0.0000000140  0.0000000837 **** 
res.kruskal2 <- healthD %>% kruskal_test(algae_growth ~ genotype)
res.kruskal2
#0.7 stat=1.42

#cat
res.kruskal2 <- healthT_jun %>% kruskal_test(algae_growth ~ cat)
res.kruskal2
#0.000000854 stat=56.9
pwcCP <- healthT_jun %>% 
  dunn_test(algae_growth ~ cat, p.adjust.method = "bonferroni") 
pwcCP
#################################  algae growth through time
res.kruskal2 <- febP %>% kruskal_test(algae_growth ~ reef)
res.kruskal2
#Na
res.kruskal2 <- febP %>% kruskal_test(algae_growth ~ genotype)
res.kruskal2
#NA
res.kruskal2 <- mayP %>% kruskal_test(algae_growth ~ reef)
res.kruskal2
#0.0964 stat=6.33
res.kruskal2 <- mayP %>% kruskal_test(algae_growth ~ genotype)
res.kruskal2
#1 stat=0.00580
res.kruskal2 <- mayP %>% kruskal_test(algae_growth ~ monrang)
res.kruskal2
#0.0964
res.kruskal2 <- augP %>% kruskal_test(algae_growth ~ reef) # equivenlant to Monmean and Monrang same
res.kruskal2
res.kruskal2 <- augP %>% kruskal_test(algae_growth ~ monmean) 
res.kruskal2
res.kruskal2 <- augP %>% kruskal_test(algae_growth ~ monrang) 
res.kruskal2
#0.0000000863 stat=35.7
pwcCP <- augP %>% 
  dunn_test(algae_growth ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 algae_growth Conch  Cary         14    16      0    1           1          ns                   
#2 algae_growth Conch  Looe         14    16      0    1           1          ns                   
#3 algae_growth Conch  Tennessee    14    15      4.78 0.00000174  0.0000105  ****                 
#4 algae_growth Cary   Looe         16    16      0    1           1          ns                   
#5 algae_growth Cary   Tennessee    16    15      4.94 0.000000766 0.00000460 ****                 
#6 algae_growth Looe   Tennessee    16    15      4.94 0.000000766 0.00000460 **** 
res.kruskal2 <- augP %>% kruskal_test(algae_growth ~ genotype)
res.kruskal2
#0.564 stat=2.04
res.kruskal2 <- decP %>% kruskal_test(algae_growth ~ reef)
res.kruskal2
#na
res.kruskal2 <- decP %>% kruskal_test(algae_growth ~ genotype)
res.kruskal2
#NA
```

```{r}
alga<-healthT_jun %>%
  group_by(reef, time) %>%
  dplyr::summarise(mean = mean(algae_growth, na.rm = TRUE),
            sd = sd(algae_growth, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
alga


### 95% CI error bars of meanmortality at each timepoint

ggplot(alga, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=lower.ci, ymax=upper.ci), width=.1) +
    geom_line() +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")
  
################### with SE bars
algaplot<-ggplot(alga, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
algaplot 
ggexport(algaplot, filename = "algaplot.pdf")




```

```{r}
dfalga<-health %>% group_by(reef, time) %>%  summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))

dates<-c("February 2019", "May 2019", "August 2019", "December 2019")
colors2 <-  thematic::okabe_ito(4)


algplot<-ggplot(dfalga, aes(x = time, y = mean, colour = reef)) +
  #geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  geom_line(linetype="dashed", size=1.5)+
  geom_point(size=2, shape=6)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Mean algae overgrowth (%)")+
  xlab("")

algplot

ggexport(algplot, filename = "algplot.pdf")
```

Rxn Norm
```{r}
alga2<-healthT_jun %>%
  group_by(reef,genotype, time) %>%
  dplyr::summarise(mean = mean(algae_growth, na.rm = TRUE),
            sd = sd(algae_growth, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
alga2

algaplot<-ggplot(alga2, aes(x=time, y=mean, colour=reef, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")+
  facet_wrap(~reef)+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
algaplot 

ggexport(algaplot, filename = "algaplotgeno.pdf")

alga2r<-healthT_jun %>%
  group_by(reef) %>%
  dplyr::summarise(mean = mean(algae_growth, na.rm = TRUE),
            sd = sd(algae_growth, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
alga2r

algaplotr<-ggplot(healthT_jun, aes(x=reef, y=algae_growth, colour=reef, group=reef)) + 
  geom_bar(position= "fill", stat= "identity") +
  #geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
  #geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
algaplotr

ggexport(algaplot, filename = "algaplotgeno.pdf")

gd <- healthN %>% 
        group_by(reef,genotype) %>% 
        dplyr::summarise(surv = mean(algae_growth, na.rm=TRUE))


RXnplotA<-ggplot(gd, aes(x = reef, y = surv, color= genotype)) +
  geom_point(stat = "identity", size =3, position=position_jitter(h=.005,w=0.25))+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Algae Growth",
    x = "Reef",
    y = "Average Algae Overgrowth (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotA
ggexport(RXnplotA, filename = "RXnplotA.pdf")
################################ reef
gdr <- healthN %>% 
        group_by(reef) %>% 
        dplyr::summarise(surv = mean(algae_growth, na.rm=TRUE))


RXnplotAr<-ggplot(gdr, aes(x = reef, y = surv, color= reef)) +
  geom_point(stat = "identity", size =3)+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Algae Growth",
    x = "Reef",
    y = "Average Algae Overgrowth (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotAr
ggexport(RXnplotAr, filename = "RXnplotAr.pdf")
```

Rxn norm over temper
```{r}
healthT_jun$cat <- paste(healthT_jun$reef,healthT_jun$genotype)
healthT_jun$cat<-as.factor(healthT_jun$cat)

algat<-healthT_jun %>%
  group_by(reef, time, monmean) %>%
  dplyr::summarise(mean = mean(algae_growth, na.rm = TRUE),
            sd = sd(algae_growth, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
algat

algaplott<-ggplot(algat, aes(x=monmean, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point( size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("Temperature (C)")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
algaplott 

algag<-healthT_jun %>%
  group_by(cat,  monmean) %>%
  dplyr::summarise(mean = mean(algae_growth, na.rm = TRUE),
            sd = sd(algae_growth, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
algag

algagplotg<-ggplot(algag, aes(x=monmean, y=mean, colour=cat, group=cat)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  #scale_colour_manual(values=colors16)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("Temperature (C)")+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
algagplotg


algai<-healthT_jun %>%
  group_by(genotype, reef) %>%
  dplyr::summarise(mean = mean(algae_growth, na.rm = TRUE),
            sd = sd(algae_growth, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
algai

algagploti<-ggplot(algai, aes(x=reef, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
algagploti
algagplotg
algaplott 
ggexport(algagploti, filename = "algaRXNploti.pdf")
ggexport(algagplotg, filename = "algaRXNplotg.pdf")
ggexport(algaplott, filename = "algaRXNplott.pdf")

```


% algae overgrowth (USING mortality both dependent on each other)
```{r}
library(gridExtra)

colors2 <-  thematic::okabe_ito(4)

#ggplot(healthN, aes(x=genotype, y=algae_growth, fill=genotype, alpha=reef)) +
#    geom_boxplot(position = position_dodge(2),alpha=0.7) +
#  geom_jitter()+
#    stat_summary(fun=mean, geom="point", shape=20, size=14, color="red", fill="red") +
#     theme_classic()+
#  scale_fill_manual(values = colors2) +
#  scale_alpha_manual(values = alpha_vals)+
#  ylab("Percent algae growth (%)")+
#  xlab("")+
#  ggtitle("Average total algae")


library(cowplot)
library(reshape)

p1 <-  ggplot(healthN, aes(x = genotype, y = algae_growth, fill = genotype,alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  #geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent algae growth (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))#+ #line is median, and closed circle is mean
  #stat_compare_means(label.y=102, method = "kruskal") #nonsignificant

p1

ggexport(p1, filename = "Avg_algae.pdf")

p1 <-  ggplot(healthN, aes(x = genotype, y = algae_growth, fill = genotype,alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  #geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent algae growth (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))#+ #line is median, and closed circle is mean
  #stat_compare_means(label.y=102, method = "kruskal") #nonsignificant

p1
# Cary   Tennessee    63    42      3.47 0.000511 0.00307 ** 
p2 <-  ggplot(healthN, aes(x = reef, y = algae_growth, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Algae overgrowth (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))
  

p2
ggexport(p2, filename = "Avg_algaeTime2.pdf")


### compare means
res.kruskal <- healthN %>% kruskal_test(algae_growth ~ time)
res.kruskal
# 0.000385
# Pairwise comparisons
pwcCP <- healthN %>% 
  dunn_test(algae_growth ~ time, p.adjust.method = "bonferroni") 
pwcCP
# time 0 and 2 and 2 and 3

p3 <- ggplot(healthN, aes(x = time, y = algae_growth, fill = time)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2) +
  theme_classic()+
  theme(legend.position="top")
p3

healthN$Time<-as.factor(healthN$time)
colors3 <-  thematic::okabe_ito(5)

p3 <-  ggplot(healthN, aes(x = time, y = algae_growth, fill = time,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  #geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors3) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent algae growth (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

p3



reefCa<-subset(healthN, reef=="Cary")
reefCo<-subset(healthN, reef=="Conch")
reefLo<-subset(healthN, reef=="Looe")
reefTe<-subset(healthN, reef=="Tennessee")

### compare genotypes at each site
res.kruskalG <- reefCa %>% kruskal_test(algae_growth ~ genotype)
res.kruskalG
# all 0's
res.kruskalG <- reefCo %>% kruskal_test(algae_growth ~ genotype)
res.kruskalG
#0.63
res.kruskalG <- reefLo %>% kruskal_test(algae_growth ~ genotype)
res.kruskalG
#0.575
res.kruskalG <- reefTe %>% kruskal_test(algae_growth ~ genotype)
res.kruskalG
#0.848
### compare means over time for each reef
res.kruskal <- reefCa %>% kruskal_test(algae_growth ~ monmean)
res.kruskal
#NA
#Pairwise comparisons
res.kruskal <- reefCo %>% kruskal_test(algae_growth ~ monmean)
res.kruskal
#NA
res.kruskal <- reefLo %>% kruskal_test(algae_growth ~ monmean)
res.kruskal
#0.411 Pairwise comparisons
pwcCP <- reefLo %>% 
  dunn_test(algae_growth ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#NA
res.kruskal <- reefTe %>% kruskal_test(algae_growth ~ monmean)
res.kruskal
#0.000268*
# Pairwise comparisons
pwcCP <- reefTe %>% 
  dunn_test(algae_growth ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#24.7-30.6
#27.7-30.6
```

algae_growth at survey timepoints
```{r}
ggplot(augP, aes(x = reef, y = algae_growth, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent algae growth (%)")+
  xlab("")+
  ggtitle("August 2019")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))


augP %>% group_by(reef) %>%  dplyr::summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))


################################# Genotype
res.kruskal <- augP %>% kruskal_test(algae_growth ~ genotype)
res.kruskal

##################################Temp
### compare means
res.kruskalT <- augP %>% kruskal_test(algae_growth ~ monrang)
res.kruskalT
#0.0000000863  same as reef 
# Pairwise comparisons
pwcCPT <- augPT %>% 
  dunn_test(algae_growth ~ monmean, p.adjust.method = "bonferroni") 
pwcCPT
#1 algae_growth 30.54692204 30.56373656    14    16      0    1           1          ns          
#2 algae_growth 30.54692204 30.56591398    14    16      0    1           1          ns          
#3 algae_growth 30.54692204 30.60366935    14    15      4.78 0.00000174  0.0000105  ****        
#4 algae_growth 30.56373656 30.56591398    16    16      0    1           1          ns          
#5 algae_growth 30.56373656 30.60366935    16    15      4.94 0.000000766 0.00000460 ****        
#6 algae_growth 30.56591398 30.60366935    16    15      4.94 0.000000766 0.00000460 **** 



junP %>% group_by(reef) %>%  summarise(n = n(), mean = mean(algae_growth, na.rm=TRUE), sd = sd(algae_growth, na.rm=TRUE))
#
#  reef      n  mean    sd
#  <fct> <int> <dbl> <dbl>
#1 Conch     8  87.5  35.4
#2 Looe     11   7    13.4

ggplot(junP, aes(x = reef, y = algae_growth, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent algae growth(%)")+
  xlab("")+
  ggtitle("June 2021")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))
```


summary statistics %mortality 
```{r}
# summary statistics for dependent variable mortality 
healthN %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthN %>% group_by(genotype) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthN %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthN %>% group_by(salinity) %>%  dplyr::summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthN %>% group_by(temp) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthN %>% group_by(monmean, reef, time) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

healthN %>% group_by( time,monrang, reef) %>% dplyr:: summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))
```



```{r}
dfmort<-health %>% group_by(reef, time) %>%  summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(mortality, na.rm=TRUE))

colors2 <-  thematic::okabe_ito(4)


mortplot<-ggplot(dfmort, aes(x = time, y = mean, colour = reef)) +
  #geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  geom_line(linetype="dashed", size=1.5)+
  geom_point(size=2, shape=6)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Mean tissue mortality (%)")+
  xlab("")

mortplot

ggexport(mortplot, filename = "mortplot.pdf")
```

```{r}
gd <- healthN %>% 
        group_by(reef,genotype) %>% 
       dplyr:: summarise(surv = mean(mortality, na.rm=TRUE))


RXnplotM<-ggplot(gd, aes(x = reef, y = surv, color= genotype)) +
  geom_point(stat = "identity", size =3, position=position_jitter(h=.005,w=0.25))+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Tissue Mortality",
    x = "Reef",
    y = "Average Tissue Mortality (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotM
ggexport(RXnplotM, filename = "RXnplotM.pdf")
################################ reef
gdr <- healthN %>% 
        group_by(reef) %>% 
        dplyr::summarise(surv = mean(mortality, na.rm=TRUE))


RXnplotMr<-ggplot(gdr, aes(x = reef, y = surv, color= reef)) +
  geom_point(stat = "identity", size =3)+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Tissue Mortality",
    x = "Reef",
    y = "Average Tissue Mortality (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotMr
ggexport(RXnplotMr, filename = "RXnplotMr.pdf")
```

Rxn norm over temper
```{r}
mortt<-healthT_jun %>%
  group_by(reef, time, monmean) %>%
  dplyr::summarise(mean = mean(mortality, na.rm = TRUE),
            sd = sd(mortality, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
mortt

mortplott<-ggplot(mortt, aes(x=monmean, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point( size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue mortality (%)")+
  xlab("Temperature (C)")+
      theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
mortplott 



mortg<-healthT_jun %>%
  group_by(genotype,  monmean) %>%
  dplyr::summarise(mean = mean(mortality, na.rm = TRUE),
            sd = sd(mortality, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
mortg

mortgplotg<-ggplot(mortg, aes(x=monmean, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue mortality (%)")+
  xlab("Temperature (C)")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
mortgplotg


morti<-healthT_jun %>%
  group_by(genotype, reef) %>%
  dplyr::summarise(mean = mean(mortality, na.rm = TRUE),
            sd = sd(mortality, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
morti

mortgploti<-ggplot(morti, aes(x=reef, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Tissue mortality (%)")+
  xlab("")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
mortgploti

mortgplotg
mortplott 
ggexport(mortgploti, filename = "mortploti.pdf")
ggexport(mortgplotg, filename = "mortplotg.pdf")
ggexport(mortplott, filename = "mortplott.pdf")

```


% Tissue Mortality
```{r}
avgmortalityplot <- ggplot(healthN, aes(x = genotype, y = mortality, fill = genotype,alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter(alpha=0.5)+
  #geom_jitter(width = 0.3) +
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Tissue mortality (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))+
  stat_compare_means(label.y=102, method = "anova") #nonsignificant

avgmortalityplot

ggexport(avgmortalityplot, filename = "avgmortalityplot.pdf")

p2 <-  ggplot(healthN, aes(x = reef, y = mortality, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Tissue mortality (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

p2
ggexport(p2, filename = "AvgMortTime2.pdf")

p2 <- ggplot(healthN, aes(x = reef, y = mortality, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  geom_jitter()+
  #geom_jitter(width = 0.3) +
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Tissue mortality (%)")+
  xlab("")+
  ggtitle("")

p2



### compare means
res.kruskal <- healthN %>% kruskal_test(mortality ~ time)
res.kruskal
# 1.3e-14
# Pairwise comparisons
pwcCP <- healthN %>% 
  dunn_test(mortality ~ time, p.adjust.method = "bonferroni") 
pwcCP
# 0-1 0-2 1-2 2-3

p3 <- ggplot(healthN, aes(x = time, y = mortality, fill = time)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2) +
  theme_classic()+
  theme(legend.position="top")
p3


# carys reef at time 0 (feb) corals were not there yet- and Looe key time 2 (may)
### compare genotypes at each site
res.kruskalG<- reefCa %>% kruskal_test(mortality ~ genotype)
res.kruskalG
# 0.128
res.kruskalG <- reefCo %>% kruskal_test(mortality ~ genotype)
res.kruskalG
#0.0576
res.kruskalG <- reefLo %>% kruskal_test(mortality ~ genotype)
res.kruskalG
#0.378
res.kruskalG <- reefTe %>% kruskal_test(mortality ~ genotype)
res.kruskalG
#0.918
res.kruskal <- reefCa %>% kruskal_test(mortality ~ monmean)
res.kruskal
#0.00014# Pairwise comparisons
pwcCP <- reefCa %>% 
  dunn_test(mortality ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#24- 30.5
#25-30.5
#27-30.5
res.kruskal <- reefCo %>% kruskal_test(mortality ~ monmean)
res.kruskal
#0.0788 Pairwise comparisons

res.kruskal <- reefLo %>% kruskal_test(mortality ~ monmean)
res.kruskal
#0.0000254 Pairwise comparisons
pwcCP <- reefLo %>% 
  dunn_test(mortality ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#24.7-30.5
#24.5-30.5
res.kruskal <- reefTe %>% kruskal_test(mortality ~ monmean)
res.kruskal
#0.0000109
# Pairwise comparisons
pwcCP <- reefTe %>% 
  dunn_test(mortality ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#24.7-30.6
#27.7-30.6
```

% mortality at survey timepoints
```{r}
ggplot(augP, aes(x = reef, y = mortality, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent mortality(%)")+
  xlab("")+
  ggtitle("August 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

```


Healthy Tissue (%)
summary statistics 
```{r}
# summary statistics for dependent variable healthy_tissue 
healthN %>% group_by(reef) %>%  dplyr::summarise(n = n(), mean = mean(mortality, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthN %>% group_by(genotype) %>%  dplyr::summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthN %>% group_by(time) %>%  dplyr::summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthN %>% group_by(salinity) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthN %>% group_by(temp) %>%  dplyr::summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))

healthN %>% group_by(monmean, reef,time) %>%  dplyr::summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))
```


```{r}
dfhea<-health %>% group_by(reef, time) %>% dplyr:: summarise(n = n(), mean = mean(healthy_tissue, na.rm=TRUE), sd = sd(healthy_tissue, na.rm=TRUE))



heaplot<-ggplot(dfhea, aes(x = time, y = mean, colour = reef)) +
  #geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  geom_line(linetype="dashed", size=1.5)+
  geom_point(size=2, shape=6)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Mean algae overgrowth (%)")+
  xlab("")

heaplot

ggexport(heaplot, filename = "heaplot.pdf")
```



```{r}
gd <- healthN %>% 
        group_by(reef,genotype) %>% 
        dplyr::summarise(surv = mean(healthy_tissue, na.rm=TRUE))


RXnplotH<-ggplot(gd, aes(x = reef, y = surv, color= genotype)) +
  geom_point(stat = "identity", size =3, position=position_jitter(h=.005,w=0.25))+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Healthy Tissue",
    x = "Reef",
    y = "Average Healthy Tissue (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotH
ggexport(RXnplotH, filename = "RXnplotH.pdf")
################################ reef
gdr <- healthN %>% 
        group_by(reef) %>% 
        dplyr::summarise(surv = mean(healthy_tissue, na.rm=TRUE))


RXnplotMr<-ggplot(gdr, aes(x = reef, y = surv, color= reef)) +
  geom_point(stat = "identity", size =3)+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Healthy Tissue",
    x = "Reef",
    y = "Average Healthy Tissue (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotMr
ggexport(RXnplotMr, filename = "RXnplotMr.pdf")
```

Rxn norm over temper
```{r}
heat<-healthT_jun %>%
  group_by(reef, time, monmean) %>%
  dplyr::summarise(mean = mean(healthy_tissue, na.rm = TRUE),
            sd = sd(healthy_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
heat

heaplott<-ggplot(heat, aes(x=monmean, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point( size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy tissue (%)")+
  xlab("Temperature (C)")+
      theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
heaplott 



heag<-healthT_jun %>%
  group_by(genotype,  monmean) %>%
  dplyr::summarise(mean = mean(healthy_tissue, na.rm = TRUE),
            sd = sd(healthy_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
heag

heagplotg<-ggplot(heag, aes(x=monmean, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy tissue (%)")+
  xlab("Temperature (C)")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
heagplotg


heai<-healthT_jun %>%
  group_by(genotype, reef) %>%
  dplyr::summarise(mean = mean(healthy_tissue, na.rm = TRUE),
            sd = sd(healthy_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
heai

heagploti<-ggplot(heai, aes(x=reef, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Healthy tissue (%)")+
  xlab("")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
heagploti

heagplotg
heaplott 
ggexport(heagploti, filename = "heaploti.pdf")
ggexport(heagplotg, filename = "heaplotg.pdf")
ggexport(heaplott, filename = "heaplott.pdf")

```


```{r}
avghealthplot <- ggplot(healthN, aes(x = reef, y = healthy_tissue, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter()+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  scale_y_reverse()+
  theme(legend.position="right")+
  ylab("Healthy tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

avghealthplot

ggexport(avghealthplot, filename = "avghealthplot.pdf")

p2 <-  ggplot(healthN, aes(x = reef, y = healthy_tissue, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Healthy tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

p2
ggexport(p2, filename = "AvgHealthTime2.pdf")


p2 <- ggplot(healthN, aes(x = genotype, y = healthy_tissue, fill = genotype,alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter()+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  scale_y_reverse()+
  theme(legend.position="right")+
  ylab("Healthy tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))
  #stat_compare_means(label.y=1, method = "anova")
p2

colors3<-c("#CC79A7","#D55E00","#009E73","#56B4E9","#F0E442")
  
### compare means
res.kruskal <- healthN %>% kruskal_test(healthy_tissue ~ time)
res.kruskal
#4.68e-21
# Pairwise comparisons
pwcCP <- healthN %>% 
  dunn_test(healthy_tissue ~ time, p.adjust.method = "bonferroni") 
pwcCP
#everything except 2-3

p3 <-  ggplot(healthN, aes(x = time, y = healthy_tissue, fill = time, alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter()+
  #geom_jitter(width = 0.3) +
  theme_classic()+
  scale_fill_manual(values = colors3) +
  scale_alpha_manual(values = alpha_vals)+
  scale_y_reverse()+
  theme(legend.position="right")+
  ylab("Healthy tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))
  #stat_compare_means(label.y=1, method = "anova")
p3

ggplot(healthN, aes(x = time, y = healthy_tissue, fill = time)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2) +
  theme_classic()+
  scale_y_reverse()+
  theme(legend.position="bottom")


### compare genotypes at each site
res.kruskalG<- reefCa %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskalG
# 0.402
res.kruskalG <- reefCo %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskalG
#0.838
res.kruskalG <- reefLo %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskalG
#0.592
res.kruskalG <- reefTe %>% kruskal_test(healthy_tissue ~ genotype)
res.kruskalG
#0.902

res.kruskal <- reefCa %>% kruskal_test(healthy_tissue ~ monmean)
res.kruskal
#**** Pairwise comparisons
pwcCP <- reefCa %>% 
  dunn_test(healthy_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal <- reefCo %>% kruskal_test(healthy_tissue ~ monmean)
res.kruskal
#****
pwcCP <- reefCo %>% 
  dunn_test(healthy_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal <- reefLo %>% kruskal_test(healthy_tissue ~ monmean)
res.kruskal
#***** Pairwise comparisons
pwcCP <- reefLo %>% 
  dunn_test(healthy_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#
res.kruskal <- reefTe %>% kruskal_test(healthy_tissue ~ monmean)
res.kruskal
#*****
# Pairwise comparisons
pwcCP <- reefTe %>% 
  dunn_test(healthy_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP

```

% healthy_tissue at survey timepoints
```{r}
ggplot(augP, aes(x = reef, y = healthy_tissue, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_y_reverse()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent healthy tissue(%)")+
  xlab("")+
  ggtitle("August 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

ggplot(decP, aes(x = reef, y = healthy_tissue, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_y_reverse()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent healthy tissue(%)")+
  xlab("")+
  ggtitle("December 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

ggplot(junP, aes(x = reef, y = healthy_tissue, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_y_reverse()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent healthy_tissue(%)")+
  xlab("")+
  ggtitle("June 2021")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

```


WHITE
summary statistics 
```{r}
# summary statistics for dependent variable white 

healthN %>% group_by(reef) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthN %>% group_by(genotype) %>%  dplyr::summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthN %>% group_by(time) %>%  dplyr::summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthN %>% group_by(salinity) %>%  dplyr::summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthN %>% group_by(temp) %>%  dplyr::summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

healthN %>% group_by(monmean, reef, time) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))

```


```{r}

dfbleach<-health %>% group_by(reef, time) %>% dplyr:: summarise(n = n(), mean = mean(white, na.rm=TRUE), sd = sd(white, na.rm=TRUE))


bleachplot<-ggplot(dfbleach, aes(x = time, y = mean, colour = reef)) +
  #geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  geom_line(linetype="dashed", size=1.5)+
  geom_point(size=2, shape=6)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Mean bleached tissue (%)")+
  xlab("")

bleachplot

ggexport(bleachplot, filename = "bleachplot.pdf")

```

```{r}
gd <- healthN %>% 
        group_by(reef,genotype) %>% 
       dplyr:: summarise(surv = mean(white, na.rm=TRUE))


RXnplotW<-ggplot(gd, aes(x = reef, y = surv, color= genotype)) +
  geom_point(stat = "identity", size =3, position=position_jitter(h=.005,w=0.25))+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Bleached Tissue",
    x = "Reef",
    y = "Average White Tissue (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotW
ggexport(RXnplotW, filename = "RXnplotW.pdf")
```


Rxn norm over temper
```{r}
white<-healthT_jun %>%
  group_by(reef, time, monmean) %>%
  dplyr::summarise(mean = mean(white, na.rm = TRUE),
            sd = sd(white, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
white

whiteplott<-ggplot(white, aes(x=monmean, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point( size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("White tissue (%)")+
  xlab("Temperature (C)")+
      theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
whiteplott 



whiteg<-healthT_jun %>%
  group_by(genotype,  monmean) %>%
  dplyr::summarise(mean = mean(white, na.rm = TRUE),
            sd = sd(white, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
whiteg

whitegplotg<-ggplot(whiteg, aes(x=monmean, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("White tissue (%)")+
  xlab("Temperature (C)")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
whitegplotg


whitei<-healthT_jun %>%
  group_by(genotype, reef) %>%
  dplyr::summarise(mean = mean(white, na.rm = TRUE),
            sd = sd(white, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
whitei

whitegploti<-ggplot(whitei, aes(x=reef, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("White tissue (%)")+
  xlab("")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
whitegploti

whitegplotg
whiteplott 
ggexport(whitegploti, filename = "whiteploti.pdf")
ggexport(whitegplotg, filename = "whiteplotg.pdf")
ggexport(whiteplott, filename = "whiteplott.pdf")
```


```{r}
p2 <- ggplot(healthN, aes(x = reef, y = white, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter()+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percetn bleached tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

p2

avgbleachplot <- ggplot(healthN, aes(x = genotype, y = white, fill = genotype,alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter()+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent bleached tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))
avgbleachplot

#ggexport(avgbleachplot, filename = "avgbleachplot.pdf")

p2 <-  ggplot(healthN, aes(x = reef, y = white, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("White tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

p2
ggexport(p2, filename = "AvgWhiteTime2.pdf")

#p1 <- ggplot(healthN, aes(x = reef, y = white, fill = reef)) +
#  geom_boxplot(outlier.shape = NA) +
#  geom_jitter(width = 0.2) +
#  theme_classic()+
#  theme(legend.position="top")

res.kruskal <- healthN %>% kruskal_test(white ~ time)
res.kruskal
#5.99e-17
# Pairwise comparisons
pwcCP <- healthN %>% 
  dunn_test(white ~ time, p.adjust.method = "bonferroni") 
pwcCP
#everything except 1-3 and 2-3

p3 <- ggplot(healthN, aes(x = time, y = white, fill = time)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2) +
  theme_classic()+
  theme(legend.position="top")
p3

### compare genotypes at each site
res.kruskalG<- reefCa %>% kruskal_test(white ~ genotype)
res.kruskalG
# 0.363
res.kruskalG <- reefCo %>% kruskal_test(white ~ genotype)
res.kruskalG
#0.89
res.kruskalG <- reefLo %>% kruskal_test(white ~ genotype)
res.kruskalG
#0.444
res.kruskalG <- reefTe %>% kruskal_test(white ~ genotype)
res.kruskalG
#0.95

#cat
res.kruskal2 <- healthT_jun %>% kruskal_test(white ~ cat)
res.kruskal2
#0.887

res.kruskal <- reefCa %>% kruskal_test(white ~ monmean)
res.kruskal
#**** Pairwise comparisons
pwcCP <- reefCa %>% 
  dunn_test(white ~ monmean, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal <- reefCo %>% kruskal_test(white ~ monmean)
res.kruskal
#****
pwcCP <- reefCo %>% 
  dunn_test(white ~ monmean, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal <- reefLo %>% kruskal_test(white ~ monmean)
res.kruskal
#***** Pairwise comparisons
pwcCP <- reefLo %>% 
  dunn_test(white ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#
res.kruskal <- reefTe %>% kruskal_test(white ~ monmean)
res.kruskal
#*****
# Pairwise comparisons
pwcCP <- reefTe %>% 
  dunn_test(white ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
```

% white at survey timepoints
```{r}
ggplot(augP, aes(x = reef, y = white, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent bleached tissue(%)")+
  xlab("")+
  ggtitle("August 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

ggplot(decP, aes(x = reef, y = white, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent healthy tissue(%)")+
  xlab("")+
  ggtitle("December 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

```

Pale tissue
summary statistics 
```{r}
# summary statistics for dependent variable pale_living_tissue 
healthN %>% group_by(reef) %>%  dplyr::summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthN %>% group_by(genotype) %>%  dplyr::summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthN %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthN %>% group_by(salinity) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthN %>% group_by(temp) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

healthN %>% group_by(monmean, reef,time) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))
```

```{r}
dfpale<-health %>% group_by(reef, time) %>% dplyr:: summarise(n = n(), mean = mean(pale_living_tissue, na.rm=TRUE), sd = sd(pale_living_tissue, na.rm=TRUE))

paleplot<-ggplot(dfpale, aes(x = time, y = mean, colour = reef)) +
  #geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  geom_line(linetype="dashed", size=1.5)+
  geom_point(size=2, shape=6)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Mean pale tissue (%)")+
  xlab("")

paleplot

ggexport(paleplot, filename = "paleplot.pdf")
```

```{r}
pale<-healthT_jun %>%
  group_by(reef, time) %>%
  dplyr::summarise(mean = mean(pale_living_tissue, na.rm = TRUE),
            sd = sd(pale_living_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
pale

### 95% CI error bars of mean pale tissue at each timepoint

ggplot(pale, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=lower.ci, ymax=upper.ci), width=.1) +
    geom_line() +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")
  
################### with SE bars
paleplot<-ggplot(pale, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
paleplot 
ggexport(paleplot, filename = "paleplot.pdf")

```


```{r}
pale2<-healthT_jun %>%
  group_by(reef,genotype, time) %>%
  dplyr::summarise(mean = mean(pale_living_tissue, na.rm = TRUE),
            sd = sd(pale_living_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
pale2

paleplot<-ggplot(pale2, aes(x=time, y=mean, colour=reef, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Algae overgrowth (%)")+
  xlab("")+
  facet_wrap(~reef)+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
paleplot 

ggexport(paleplot, filename = "paleplotgeno.pdf")
```

```{r}
gd <- healthN %>% 
        group_by(reef,genotype) %>% 
        dplyr::summarise(surv = mean(pale_living_tissue, na.rm=TRUE))


RXnplotP<-ggplot(gd, aes(x = reef, y = surv, color= genotype)) +
  geom_point(stat = "identity", size =3, position=position_jitter(h=.005,w=0.25))+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Pale Tissue",
    x = "Reef",
    y = "Average Pale Tissue (%)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotP
ggexport(RXnplotP, filename = "RXnplotP.pdf")
```

Rxn norm over temper
```{r}
pale<-healthT_jun %>%
  group_by(reef, time, monmean) %>%
  dplyr::summarise(mean = mean(pale_living_tissue, na.rm = TRUE),
            sd = sd(pale_living_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
pale

paleplott<-ggplot(pale, aes(x=monmean, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point( size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Pale tissue (%)")+
  xlab("Temperature (C)")+
      theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
paleplott 



paleg<-healthT_jun %>%
  group_by(genotype,  monmean) %>%
  dplyr::summarise(mean = mean(pale_living_tissue, na.rm = TRUE),
            sd = sd(pale_living_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
paleg

palegplotg<-ggplot(paleg, aes(x=monmean, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Pale tissue (%)")+
  xlab("Temperature (C)")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
palegplotg


palei<-healthT_jun %>%
  group_by(genotype, reef) %>%
  dplyr::summarise(mean = mean(pale_living_tissue, na.rm = TRUE),
            sd = sd(pale_living_tissue, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
palei

palegploti<-ggplot(palei, aes(x=reef, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Pale tissue (%)")+
  xlab("")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
palegploti

palegplotg
paleplott 
ggexport(palegploti, filename = "paleploti.pdf")
ggexport(palegplotg, filename = "paleplotg.pdf")
ggexport(paleplott, filename = "paleplott.pdf")
```

pale comparisons
```{r}
#################################  pale tissue
res.kruskal2 <- healthD %>% kruskal_test(pale_living_tissue ~ reef)
res.kruskal2
#.709 stat= 1.39
res.kruskal2 <- healthD %>% kruskal_test(pale_living_tissue ~ monmean)
res.kruskal2
#2.94e-21
res.kruskal2 <- healthD %>% kruskal_test(pale_living_tissue ~ monrang)
res.kruskal2
#same as monmean
pwcCP <- healthD %>% 
  dunn_test(pale_living_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
res.kruskal2 <- healthD %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskal2
#0.607 stat=1.84
#cat
res.kruskal2 <- healthT_jun %>% kruskal_test(pale_living_tissue ~ cat)
res.kruskal2
#0.917 
#################################  algae growth through time
res.kruskal2 <- febP %>% kruskal_test(pale_living_tissue ~ reef)
res.kruskal2
#Na
res.kruskal2 <- febP %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskal2
#NA
res.kruskal2 <- mayP %>% kruskal_test(pale_living_tissue ~ reef)
res.kruskal2
#0.293 stat=3.72
res.kruskal2 <- mayP %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskal2
#0.0947 stat=6.38
res.kruskal2 <- mayP %>% kruskal_test(pale_living_tissue ~ monrang)
res.kruskal2
#0.293
res.kruskal2 <- augP %>% kruskal_test(pale_living_tissue ~ reef) # equivenlant to Monmean and Monrang same
res.kruskal2
#0.00000568
res.kruskal2 <- augP %>% kruskal_test(pale_living_tissue ~ monmean) 
res.kruskal2
res.kruskal2 <- augP %>% kruskal_test(pale_living_tissue ~ monrang) 
res.kruskal2
#0.00000568 stat=27.1
pwcCP <- augP %>% 
  dunn_test(pale_living_tissue ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 pale_living_tissue Conch  Cary         14    16     2.97  0.00300    0.0180    *                          
#2 pale_living_tissue Conch  Looe         14    16     4.35  0.0000138  0.0000827 ****                       
#3 pale_living_tissue Conch  Tennessee    14    12     4.64  0.00000355 0.0000213 ****                       
#4 pale_living_tissue Cary   Looe         16    16     1.43  0.153      0.919     ns                         
#5 pale_living_tissue Cary   Tennessee    16    12     1.93  0.0533     0.320     ns                         
#6 pale_living_tissue Looe   Tennessee    16    12     0.610 0.542      1         ns
res.kruskal2 <- augP %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskal2
#0.991 stat=.111
res.kruskal2 <- decP %>% kruskal_test(pale_living_tissue ~ reef)
res.kruskal2
#0.000171 stat= 17.3
pwcCP <- decP %>% 
  dunn_test(pale_living_tissue ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 pale_living_tissue Conch  Cary      14    15     -4.14 0.0000340 0.000102 ***         
#2 pale_living_tissue Conch  Looe      14    14     -1.76 0.0788    0.236    ns          
#3 pale_living_tissue Cary   Looe      15    14      2.36 0.0184    0.0553   ns  
res.kruskal2 <- decP %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskal2
#0.766 stat= 1.15

res.kruskal2 <- decP %>% kruskal_test(pale_living_tissue ~ monrang)
res.kruskal2
#0.000171 stat= 17.3
pwcCP <- decP %>% 
  dunn_test(pale_living_tissue ~ monrang, p.adjust.method = "bonferroni") 
pwcCP

```


```{r}
p2 <- ggplot(healthN, aes(x = reef, y = pale_living_tissue, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter()+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percetn bleached tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))
p2

avgpaleplot <- ggplot(healthN, aes(x = genotype, y = pale_living_tissue, fill = genotype,alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  #geom_jitter()+
  #geom_jitter(width = 0.3) +
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent pale live tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

  avgpaleplot

#ggexport(avgpaleplot, filename = "avgpaleplot.pdf")

  p2 <-  ggplot(healthN, aes(x = reef, y = pale_living_tissue, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Pale living tissue (%)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

p2
ggexport(p2, filename = "AvgPaleTime2.pdf")
  

res.kruskal <- healthN %>% kruskal_test(pale_living_tissue ~ time)
res.kruskal
#1.98e-19
# Pairwise comparisons
pwcCP <- healthN %>% 
  dunn_test(pale_living_tissue ~ time, p.adjust.method = "bonferroni") 
pwcCP 
# all except 1-3 and 2-3

p3 <- ggplot(healthN, aes(x = time, y = pale_living_tissue, fill = time)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2) +
  theme_classic()+
  theme(legend.position="top")
p3


### compare genotypes at each site
res.kruskalG<- reefCa %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskalG
# 0.95
res.kruskalG <- reefCo %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskalG
#0.777
res.kruskalG <- reefLo %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskalG
#0.726
res.kruskalG <- reefTe %>% kruskal_test(pale_living_tissue ~ genotype)
res.kruskalG
#0.273

res.kruskal <- reefCa %>% kruskal_test(pale_living_tissue ~ monmean)
res.kruskal
#**** Pairwise comparisons
pwcCP <- reefCa %>% 
  dunn_test(pale_living_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal <- reefCo %>% kruskal_test(pale_living_tissue ~ monmean)
res.kruskal
#****
pwcCP <- reefCo %>% 
  dunn_test(pale_living_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP

res.kruskal <- reefLo %>% kruskal_test(pale_living_tissue ~ monmean)
res.kruskal
#***** Pairwise comparisons
pwcCP <- reefLo %>% 
  dunn_test(pale_living_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#
res.kruskal <- reefTe %>% kruskal_test(pale_living_tissue ~ monmean)
res.kruskal
#*****
# Pairwise comparisons
pwcCP <- reefTe %>% 
  dunn_test(pale_living_tissue ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
```

% pale_living_tissue at survey timepoints
```{r}
ggplot(augP, aes(x = reef, y = pale_living_tissue, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent pale tissue(%)")+
  xlab("")+
  ggtitle("August 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))


ggplot(decP, aes(x = reef, y = pale_living_tissue, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent pale tissue(%)")+
  xlab("")+
  ggtitle("December 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))


ggplot(junP, aes(x = reef, y = pale_living_tissue, fill = reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Percent pale tissue(%)")+
  xlab("")+
  ggtitle("December 2019")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

```



photosynthesis
summary statistics 
```{r}
# summary statistics for dependent variable pale_living_tissue 
healthN %>% group_by(reef) %>%  dplyr::summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))

healthN %>% group_by(genotype) %>%  dplyr::summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))

healthN %>% group_by(time) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))

healthN %>% group_by(monmean, reef,time) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))
```

```{r}
dfphot<-healthN %>% group_by(reef, time) %>% dplyr:: summarise(n = n(), mean = mean(p_rate, na.rm=TRUE), sd = sd(p_rate, na.rm=TRUE))

phoplot<-ggplot(dfphot, aes(x = time, y = mean, colour = reef)) +
  #geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd))+
  geom_line(linetype="dashed", size=1.5)+
  geom_point(size=2, shape=6)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Mean photosynthesis rate (umol/kg)")+
  xlab("")

phoplot

```

```{r}
photo<-healthT_jun %>%
  group_by(reef, time) %>%
  dplyr::summarise(mean = mean(p_rate, na.rm = TRUE),
            sd = sd(p_rate, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
photo

### 95% CI error bars of mean photo tissue at each timepoint

ggplot(photo, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=lower.ci, ymax=upper.ci), width=.1) +
    geom_line() +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")
  
################### with SE bars
photoplot<-ggplot(photo, aes(x=time, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
photoplot 
ggexport(photoplot, filename = "photoplot.pdf")

################### with SE bars genotype
photog<-healthT_jun %>%
  group_by(genotype, time) %>%
  dplyr::summarise(mean = mean(p_rate, na.rm = TRUE),
            sd = sd(p_rate, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
photog

photoplotg<-ggplot(photog, aes(x=time, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
photoplotg
#ggexport(photoplotg, filename = "photoplotg2.pdf")
```


```{r}
pho2<-healthT_jun %>%
  group_by(reef,genotype, time) %>%
  dplyr::summarise(mean = mean(p_rate, na.rm = TRUE),
            sd = sd(p_rate, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
pho2

phoplot<-ggplot(pho2, aes(x=time, y=mean, colour=reef, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
  facet_wrap(~reef)+
   theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))
phoplot 

```

```{r}
gd <- healthN %>% 
        group_by(reef,genotype) %>% 
        dplyr::summarise(surv = mean(p_rate, na.rm=TRUE))


RXnplotPh<-ggplot(gd, aes(x = reef, y = surv, color= genotype)) +
  geom_point(stat = "identity", size =3, position=position_jitter(h=.005,w=0.25))+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Photosynthesis",
    x = "Reef",
    y = "Photosynthesis rate (umol/kg)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotPh
ggexport(RXnplotPh, filename = "RXnplotPh.pdf")

################################ reef
gdr <- healthN %>% 
        group_by(reef) %>% 
        dplyr::summarise(surv = mean(p_rate, na.rm=TRUE))


RXnplotPhr<-ggplot(gdr, aes(x = reef, y = surv, color= reef)) +
  geom_point(stat = "identity", size =3)+
  theme_classic()+
  scale_colour_manual(values=colors2) +
  guides(color = guide_legend("Genotype"),  shape = guide_legend("Genotype")) +
  labs(
    title = "GxE Photosynthesis",
    x = "Reef",
    y = "Photosynthesis rate (umol/kg)"
  )+
  theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))

RXnplotPhr
ggexport(RXnplotPhr, filename = "RXnplotPhr.pdf")
```

Rxn norm over temper
```{r}
p_rate<-healthT_jun %>%
  group_by(reef, time, monmean) %>%
  dplyr::summarise(mean = mean(p_rate, na.rm = TRUE),
            sd = sd(p_rate, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
p_rate

p_rateplott<-ggplot(p_rate, aes(x=monmean, y=mean, colour=reef, group=reef)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point( size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("Temperature (C)")+
      theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
p_rateplott 



p_rateg<-healthT_jun %>%
  group_by(genotype,  monmean) %>%
  dplyr::summarise(mean = mean(p_rate, na.rm = TRUE),
            sd = sd(p_rate, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
p_rateg

p_rategplotg<-ggplot(p_rateg, aes(x=monmean, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("Temperature (C)")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
p_rategplotg


p_ratei<-healthT_jun %>%
  group_by(genotype, reef) %>%
  dplyr::summarise(mean = mean(p_rate, na.rm = TRUE),
            sd = sd(p_rate, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower.ci = mean - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = mean + qt(1 - (0.05 / 2), n - 1) * se)
  
p_ratei

p_rategploti<-ggplot(p_ratei, aes(x=reef, y=mean, colour=genotype, group=genotype)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1) +
    geom_line(linetype= "dashed") +
    geom_point(size=3)+
  scale_colour_manual(values=colors2)+
  theme_classic()+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
    theme(axis.text = element_text(size = 13))+
  theme(axis.title = element_text(size = 14))+
  theme(legend.title = element_text(size=12))+
  theme(legend.text = element_text(size=12))
p_rategploti

p_rategplotg
p_rateplott 
ggexport(p_rategploti, filename = "p_rateploti.pdf")
ggexport(p_rategplotg, filename = "p_rateplotg.pdf")
ggexport(p_rateplott, filename = "p_rateplott.pdf")
```

photo comparisons
```{r}
#################################  Photo rates
res.kruskal2 <- healthD %>% kruskal_test(p_rate ~ reef)
res.kruskal2
#0.023 stat= 9.53
pwcCP <- healthD %>% 
  dunn_test(p_rate ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#4 p_rate Cary   Looe         16    24    -2.70  0.00691 0.0415 *           
#5 p_rate Cary   Tennessee    16    19    -2.77  0.00567 0.0340 *
res.kruskal2 <- healthD %>% kruskal_test(p_rate ~ monmean)
res.kruskal2
#0.0000966 stat=31.9
res.kruskal2 <- healthD %>% kruskal_test(p_rate ~ monrang)
res.kruskal2
#0.0000895 stat=34.0
res.kruskal2 <- healthD %>% kruskal_test(p_rate ~ genotype)
res.kruskal2
#0.387 stat=3.03
#cat
res.kruskal2 <- healthT_jun %>% kruskal_test(p_rate ~ cat)
res.kruskal2
#0.184

#################################  phtoo through time
res.kruskal2 <- febP %>% kruskal_test(p_rate ~ reef)
res.kruskal2
#0.549
res.kruskal2 <- febP %>% kruskal_test(p_rate ~ genotype)
res.kruskal2
#0.00889 stat- 11.6
pwcCP <- febP %>% 
  dunn_test(p_rate ~ genotype, p.adjust.method = "bonferroni") 
pwcCP
#6 p_rate C      D          8     7     3.30  0.000975 0.00585 ** 

res.kruskal2 <- mayP %>% kruskal_test(p_rate ~ reef)
res.kruskal2
#0.0223
res.kruskal2 <- mayP %>% kruskal_test(p_rate ~ monrang)
res.kruskal2
#0.0223 stat=5.22
pwcCP <- mayP %>% 
  dunn_test(p_rate ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#conch-Tenn
res.kruskal2 <- mayP %>% kruskal_test(p_rate ~ genotype)
res.kruskal2
#0.1615 stat=5.10

res.kruskal2 <- augP %>% kruskal_test(p_rate ~ reef) # equivenlant to Monmean and Monrang same
res.kruskal2
#0.00612 stat= 12.4
res.kruskal2 <- augP %>% kruskal_test(p_rate ~ monmean) 
res.kruskal2
res.kruskal2 <- augP %>% kruskal_test(p_rate ~ monrang) 
res.kruskal2
#0.00612 stat=12.4
pwcCP <- augP %>% 
  dunn_test(p_rate ~ reef, p.adjust.method = "bonferroni") 
pwcCP
#1 p_rate Conch  Cary          7     8     2.42  0.0155  0.0931 ns          
#2 p_rate Conch  Looe          7     8    -0.222 0.824   1      ns          
#3 p_rate Conch  Tennessee     7     5    -0.866 0.386   1      ns          
#4 p_rate Cary   Looe          8     8    -2.74  0.00623 0.0374 *           
#5 p_rate Cary   Tennessee     8     5    -3.09  0.00202 0.0121 *           
#6 p_rate Looe   Tennessee     8     5    -0.688 0.492   1      ns 

res.kruskal2 <- augP %>% kruskal_test(p_rate ~ genotype)
res.kruskal2
#0.841

res.kruskal2 <- decP %>% kruskal_test(p_rate ~ reef)
res.kruskal2
#0.908 stat=0.0134
res.kruskal2 <- decP %>% kruskal_test(p_rate ~ monrang)
res.kruskal2
#0.908 stat=0.0134
 
res.kruskal2 <- decP %>% kruskal_test(p_rate ~ genotype)
res.kruskal2
#0.1 stat= 6.24
```


```{r}
p2 <- ggplot(healthN, aes(x = reef, y = p_rate, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  geom_jitter()+
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
  ggtitle("")
p2

avgphoplot <- ggplot(healthN, aes(x = genotype, y = p_rate, fill = genotype,alpha=reef)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_boxplot(position = position_dodge(1))+
  geom_jitter()+
  #geom_jitter(width = 0.3) +
  theme_classic()+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

  avgphoplot

#ggexport(avgpaleplot, filename = "avgpaleplot.pdf")

  p2 <-  ggplot(healthN, aes(x = reef, y = p_rate, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Photosynthesis rate (umol/kg)")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))

p2
ggexport(p2, filename = "AvgPhoTime2.pdf")
  

res.kruskal <- healthN %>% kruskal_test(p_rate ~ time)
res.kruskal
#0.0666 stat= 7.17
# Pairwise comparisons
pwcCP <- healthN %>% 
  dunn_test(p_rate ~ time, p.adjust.method = "bonferroni") 
pwcCP 
# all except 1-3 and 2-3

p3 <- ggplot(healthN, aes(x = time, y = p_rate, fill = time)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2) +
  theme_classic()+
  theme(legend.position="top")
p3


### compare genotypes at each site
res.kruskalG<- reefCa %>% kruskal_test(p_rate ~ genotype)
res.kruskalG
# 0.472
res.kruskalG <- reefCo %>% kruskal_test(p_rate ~ genotype)
res.kruskalG
#0.801
res.kruskalG <- reefLo %>% kruskal_test(p_rate ~ genotype)
res.kruskalG
#0.0891
res.kruskalG <- reefTe %>% kruskal_test(p_rate ~ genotype)
res.kruskalG
#0.355
res.kruskal <- reefCa %>% kruskal_test(p_rate ~ monmean)
res.kruskal
#0.115
#Pairwise comparisons
res.kruskal <- reefCo %>% kruskal_test(p_rate ~ monmean)
res.kruskal
#0.0225
pwcCP <- reefCo %>% 
  dunn_test(p_rate ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#27.30.5
res.kruskal <- reefLo %>% kruskal_test(p_rate ~ monmean)
res.kruskal
#0.0187 Pairwise comparisons
pwcCP <- reefLo %>% 
  dunn_test(p_rate ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#25.4-30.5
res.kruskal <- reefTe %>% kruskal_test(p_rate ~ monmean)
res.kruskal
#0.0272**
# Pairwise comparisons
pwcCP <- reefTe %>% 
  dunn_test(p_rate ~ monmean, p.adjust.method = "bonferroni") 
pwcCP
#24.7-30.6

```


additional environmental data to explain Conch's strange responses in Dec- cooler temperatures=negative responses= not consistent with other genotypes at other sites with similar temp exposure--- sedimentation? access nutrients?
Data taken from SERC southeast environmental research center the water quality monitoring project for the FKNMS
http://serc.fiu.edu/wqmnetwork/FKNMS-CD/DataDL.htm
Sites
```{r}
## Load packages
# library(devtools) # will need devtools to download ggfortify from GitHub directly 
# install_github('sinhrks/ggfortify')
library(dplyr) # necessary for PCA function
library(ggbiplot) # plotting the PCA
library(ggfortify) # plotting the PCA
library(vegan) # running the PERMANOVA (adonis2())
library(ggpubr) # for arranging multiple plots into single figure
#source("Plasticity_function/PCAplast_function.R") # source the plasticity function

Rxndi <- read.csv("C:/Github/Orbicella_FL/Raw Data/All_envionr_health.csv")
RxndiD<-Rxndi%>% subset(Time!="4")
head(RxndiD)
str(RxndiD)
RxndiD$Genotype<-as.factor(RxndiD$Reef)
RxndiD$Genotype<-as.factor(RxndiD$Genotype)
View(RxndiD)
RxndiD2<-RxndiD[54:58]
RxndiD2<-RxndiD[c(10:11,12, 13:15, 17)]

head(RxndiD2)
pca_input<-RxndiD2

## Perform principal component analysis (PCA)
pca_df <- prcomp(na.omit(pca_input), center = TRUE, scale = TRUE)

adonis_out <- adonis2(pca_input ~ Reef, data = RxndiD, method = 'eu', na.rm=TRUE)
adonis_out

## plot the PCA coloured by species
pca_plot <- autoplot(pca_df, data = RxndiD, 
         colour = "Reef",
         shape = "Reef",
         fill = "Reef",               
         frame = TRUE, 
         frame.type = "t", # multivariate t-distributions for small n producing heavier tails
         frame.level = 0.95) + # using 95% CI for all ellipses
  theme_classic()
pca_plot

```

```{r}
## To run the function, enter the following objects:
# PCAplast(pca = XXX, # the PCA dataframe containing the PCA eigenvalues
#          data = XXX, # the condition/treatment data corresponding to samples
#          sample_ID = "XXX", # the name of column that provide unique ID per sample (if blank, will pull rownames for this)
#          num_pca =  "XXX", # the number of PCAs to include in analysis (default is 'all', but you can specify another number with a minimum of 2 PCAs)
#          control_col = "XXX", # what the 'treatment' column is called
#          control_lvl = "XXX", # control level of the treatment. If blank, a control mean per control level is assumed
#          group = "XXX") # the grouping column (i.e., colony). If blank, will assume control level grouping only!



########################################################################################

PCAplast <- function(pca, data, sample_ID = NA, num_pca = "all", control_col, control_lvl = "none", group = NA) {
  
  # rename the user input info
  pca_df <- pca
  data_df <- data
  control_name <- control_col
  control_lvl <- control_lvl
  group_col <- group
  
  # ifelse statement to pull PCs from dataframe or prcomp objects
  if(class(pca_df) == "prcomp"){
    pca_dist <- pca_df$x # grab PC distances from prcomp() object
  } else {
    pca_dist <- pca_df # grab PC distances from data.frame object
  }
  
  
  # check for correct number of PCAs provided
  if(class(num_pca) == "numeric") {
    if(num_pca < 2) { # will throw error if too few PCAs requested
      stop("please select more than 2 PCs to calculate distance")
    } 
  }
  
  if(class(num_pca) == "numeric") {
    if(num_pca > (pca_dist %>% dplyr::select(starts_with("PCA")) %>% ncol())) { # will throw error if too many PCAs requested
      stop(paste(num_pca, "PCs requested for calculation, but only", (pca_dist %>% dplyr::select(starts_with("PCA")) %>% ncol()), "PCs available. Select appropriate number of PCAs for calculation."))
    } 
  }
  
  
  # oder the dataframe to ensure correct pairing after calculating distance 
  if(sample_ID %in% colnames(data_df)){
    data_df <- data_df[order(data_df[[sample_ID]]),]
  } else {
    data_df <- data_df[order(row.names(data_df)),]
  }
  
  
  # combine the datasets
  dist_df <- cbind(data_df, pca_dist) 
  
  
  # if there is no control level, modify so function pulls all levels
  if(control_lvl == "none") {
    control_lvl = levels(dist_df[[control_name]])
  } else {
    control_lvl = control_lvl
  }
  
  
  # make dataframe of control grouping only
  if(!is.na(group_col)) { # calculate mean per grouping ID (if provided)
    mean_control <- dist_df %>%
      filter(dist_df[[control_name]] == list(control_lvl)[[1]]) %>% 
      rename_with(tolower) %>% # renames all pc's with lowercase 'PC' (just to differentiate from all sample PCs)
      dplyr::select(colnames((dist_df %>% rename_with(tolower))[tolower(group_col)]), starts_with("pc"))
    
    # add the control PCA values to treatment samples per grouping
    dist_df2 <- left_join(dist_df, mean_control, by.x = group_col, by.y = tolower(group_col))
    
  } else { # calculate mean per control treatment
    mean_control <- dist_df %>%
      filter(dist_df[[control_name]] == list(control_lvl)[[1]]) %>% 
      rename_with(tolower) %>% # renames all pc's with lowercase 'PC' (just to differentiate from all sample PCs)
      dplyr::select(colnames((dist_df %>% rename_with(tolower))[tolower(control_name)]), starts_with("pc")) %>% # select just the PCs 
      #group_by() 
      group_by_at(vars(tolower(control_name))) %>% 
      summarise_if(is.numeric, mean)
    
    # add the control PCA values to all samples 
    dist_df2 <- merge(dist_df, mean_control, by.x = control_col, by.y = tolower(control_col), all.x = TRUE)
    
  }
  
  
  
  # again, reorder data
  if(sample_ID %in% colnames(data_df)){
    dist_df2 <- dist_df2[order(dist_df2[[sample_ID]]),]
  } else {
    rownames(dist_df2) <- rownames(data_df)
    dist_df2 <- dist_df2[order(rownames(dist_df2)),]
  }
  
  
  ### Calculate sample (PCA) distances from control (pca) using all PCAs
  # make dataframe to populate with pca distances
  full_calc_dist <- data.frame(control_name = dist_df2[control_name])
  
  if(num_pca == "all") {
    ## forloop that will calculate distances between control and sample for all PCs (n will be total number)
    for(n in 1:(dist_df %>% dplyr::select(starts_with("PC")) %>% ncol())){
      # makes the PCA column name for control (lowercase) and sample (uppercase)
      PC_col <- paste0("PC", n)
      pc_col <- paste0("pc", n)
      
      # pulls the PC column for control (lowercase) and sample (uppercase)
      PCx <- dist_df2[PC_col]
      pcx <- dist_df2[pc_col]
      
      pca_calc_dist <- data.frame((PCx - pcx)^2) # calculates the distance between 2 PCs
      full_calc_dist <- cbind(full_calc_dist, pca_calc_dist) # add that distance to running dataframe
    }
  } else {
    ## forloop that will calculate distances between control and sample for SPECIFIED # of PCs (n will be total number)
    for(n in 1:as.numeric(num_pca)){
      # makes the PC column name for control (lowercase) and sample (uppercase)
      PC_col <- paste0("PC", n)
      pc_col <- paste0("pc", n)
      
      # pulls the PC column for control (lowercase) and sample (uppercase)
      PCx <- dist_df2[PC_col]
      pcx <- dist_df2[pc_col]
      
      pca_calc_dist <- data.frame((PCx - pcx)^2) # calculates the distance between 2 PCs
      full_calc_dist <- cbind(full_calc_dist, pca_calc_dist) # add that distance to running dataframe
    }
  }
  
  
  ## final distance calculation (adds all PCA distances and takes squareroot)
  distance <- full_calc_dist %>% 
    mutate(dis_sum = rowSums(across(where(is.numeric)))) %>% 
    mutate(dist = sqrt(dis_sum)) %>% 
    dplyr::select(matches("dist"))
  
  
  ## combine the calculated distance with the metadata and remove controls for final dataframe
  dist_df <- data_df %>% 
    bind_cols(distance) %>% 
    filter(!is.na(dist)) 
  
  ## removes the control levels
  if(length(control_lvl) > 1){
    dist_df <- dist_df
  } else {
    dist_df <- dist_df %>%
      filter(dist_df[[control_name]] != control_lvl)  %>% 
      droplevels()
  }

}


#################################################################

```


```{r}
## To run the plasticity function, enter the following objects:
plast_out <- PCAplast(pca = pca_df, # the PCA dataframe containing the PCA eigenvalues
         data = RxndiD, # the condition/treatment data corresponding to samples
         #sample_ID = "XXX", # the name of column that provide unique ID per sample (if blank, will pull rownames for this)
         num_pca =  "all", # the number of PCAs to include in analysis (default is 'all', but you can specify another number with a minimum of 2 PCAs)
         #control_lvl = "XXX", # control level of the treatment. If blank, a control mean per control level is assumed
         #group = "XXX", # the grouping column (i.e., colony). If blank, will assume control level grouping only!
         control_col = "Reef") # what the 'treatment' column is called

```

########### done

FACTORS: genotype, reef, 
Distribution of data: count data (non-negative)
```{r}
################################
ggdensity(healthN$mortality, 
          main = "Density plot of % algae",
          xlab = "")
hist(healthN$mortality)
mean(healthN$mortality, na.rm=TRUE)
var(healthN$mortality, na.rm=TRUE)

ggdensity(healthN$mortality, 
          main = "Density plot of % mortality",
          xlab = "")
hist(healthN$mortality)
mean(healthN$mortality, na.rm=TRUE)
var(healthN$mortality, na.rm=TRUE)

ggdensity(healthN$healthy_tissue, 
          main = "Density plot of % healthy tissue",
          xlab = "")
hist(healthN$healthy_tissue)
mean(healthN$healthy_tissue, na.rm= TRUE)
var(healthN$healthy_tissue, na.rm= TRUE)

ggdensity(healthN$white, 
          main = "Density plot of % white tissue",
          xlab = "")
hist(healthN$white)
mean(healthN$white,na.rm=TRUE)
var(healthN$white,na.rm=TRUE)

ggdensity(healthN$pale_living_tissue, 
          main = "Density plot of % living tissue",
          xlab = "")
hist(healthN$pale_living_tissue)
mean(healthN$pale_living_tissue, na.rm=TRUE)
var(healthN$pale_living_tissue, na.rm=TRUE)

ggdensity(healthN$fish_bites, 
          main = "Density plot of number of fish bites",
          xlab = "")
hist(healthN$fish_bites)
mean(healthN$fish_bites, na.rm=TRUE)
var(healthN$fish_bites, na.rm=TRUE)
```


GLM modelling 
https://www.statology.org/interpret-glm-output-in-r/
The coefficient estimate in the output indicate the average change in the log odds of the response variable associated with a one unit increase in each predictor variable.

GLM models poisson, quasipoisson do not work for this data set- Compare means for health. ABOVE
```{r}
library(multcomp)

#TEST<-healthD
#TEST$salinity<-as.factor(TEST$salinity)
#TEST$temp<-as.factor(TEST$temp)
#TEST$depth<-as.factor(TEST$depth)
#str(TEST)
mod.ori <- glm(algae_growth~reef+genotype+time+salinity+temp+depth, data=healthD,family= "poisson"(link="log"))
summary(mod.ori)
Tuki<-glht(mod.ori, mcp(reef="Tukey"))
summary(Tuki)
# Exponentiated coefficients
exp(coef(mod.ori))
# Goodness-of-fit test
gof.pvalue = 1 - pchisq(mod.ori$deviance, mod.ori$df.residual)
gof.pvalue
#Both covariates are statistically significant, but a goodness-of-fit test reveals that there remains significant lack-of-fit
mod.ori <- glm(algae_growth~reef*genotype, data=healthD,family= "poisson"(link="log"))
summary(mod.ori)
Tuki<-glht(mod.ori, mcp(reef="Tukey"))
summary(Tuki)

mod.ori <- glm(algae_growth~reef+genotype+time+salinity+temp+depth+reef:genotype, data=TEST,family= "poisson"(link="log"))
summary(mod.ori)

ult_comp <- summary(glht(mod.ori, mcp(region="Tukey")))

mod.orm <- glm(mortality~reef+genotype+time+salinity+temp+depth, data=healthD,family= "poisson"(link="log"))
summary(mod.orm)
mod.orh <- glm(healthy_tissue~reef+genotype+time+salinity+temp+depth, data=healthD,family= "poisson"(link="log"))
summary(mod.orh)
mod.orw <- glm(white~reef+genotype+time+salinity+temp+depth, data=healthD,family= "poisson"(link="log"))
summary(mod.orw)
mod.orp <- glm(pale_living_tissue~reef+genotype+time+salinity+temp+depth, data=healthD,family= "poisson"(link="log"))
summary(mod.orp)

#model is not overdispersed 
#(Dispersion parameter for poisson family taken to be 1)
#The negative coefficient for Cary & Looe indicates that as reef differs from Conch, the mean number of algae growth is smaller.

mod.orq <- glm(algae_growth~reef*genotype, data=healthD,family= "quasipoisson"(link="log"))
summary(mod.orq)

# compare models
library(arm)

# extract coefficients from first model using 'coef()'
coef1 = coef(mod.ori)

# extract coefficients from second model
coef2 = coef(mod.orq)

# extract standard errors from first model using 'se.coef()'
se.coef1 = se.coef(mod.ori)

# extract standard errors from second model
se.coef2 = se.coef(mod.orq)

# use 'cbind()' to combine values into one dataframe
models.both <- cbind(coef1, se.coef1, coef2, se.coef2, exponent = exp(coef1))

# show dataframe
models.both

# coefficients are the same but standard errors are different
#estiamte Tennessee reef by subtracting 1 from the exponent
1-1.870000e+0
-0.87 # Comparing Conch to tennesse results in a DECREASE in algae by 0.87 times if we change from Conch to Tennessee we see 87% less algae at Tennessee assuming all other variables are the same




mod.orO <- glm(Palgae~reef+genotype+, data=healthD,family= "poisson"(link="log"))
summary(mod.orO)


#checking glm assumptions
#residuals
#plot the residuals against estimates (mu_i) first
plot(residuals(mod.ori) ~ predict(mod.ori,type="response"),xlab=expression(hat(mu)),ylab="Deviance residuals",pch=20,col="red")




plot(residuals(mod.ori) ~ predict(mod.ori,type="response"),xlab=expression(hat(mu)),ylab="Deviance residuals",pch=20,col="red")
plot(residuals(mod.ori) ~ predict(mod.ori,type="link"),xlab=expression(hat(eta)),ylab="Deviance residuals",pch=20,col="blue")



## outliers 
i_n = influence(mod.ori)$hat # calculate the influence of data points
which.max(i_n)
c_d = cooks.distance(mod.ori)
which.max(c_d)
halfnorm((i_n))

Anova(mod.ori, test = "F")

mod.orir <- glm(cbind(algae_growth)~reef, data=healthD,family= "poisson")
summary(mod.orir)

mod.orig <- glm(cbind(algae_growth)~genotype, data=healthD,family= "poisson")
summary(mod.orig)

##################### Likelihood test to determine best model
#Likelihood ratio tests are used to compare the goodness of fit of two statistical models. The LRT compares two hierarchically nested models to determine whether or not adding complexity to your model (i.e., adding more parameters) makes your model significantly more accurate. The hierarchically nested models simply means that the complex model differs only from the simpler (or nested) model by the addition of one or more parameters.https://api.rpubs.com/tomanderson_34/lrt

(A <- logLik(mod.orir))
(B <- logLik(mod.orig))
(C <- logLik(mod.ori))

#16-4= 12
(teststat <- -2 * (as.numeric(A)-as.numeric(C)))
(p.val <- pchisq(teststat, df = 12, lower.tail = FALSE))
#A common significance level to use is .05. Under that significance level, we would reject the null hypothesis and conclude that we should use the more complex model
library(lmtest)
lrtest(mod.orir, mod.ori)

(teststat <- -2 * (as.numeric(A)-as.numeric(B)))
(p.val <- pchisq(teststat, df = 12, lower.tail = FALSE))
lrtest(mod.orig, mod.ori)

################# testing GAM

gami <- gam(algae_growth ~ reef*genotype, family = poisson(link = log), 
    data = healthD)
summary(gami)

AIC(gami,mod.ori)
anova(mod.ori,gami, test = "Chisq")

library(mgcv)
gami <- gam(algae_growth ~ reef*genotype, data = healthD)
summary(gami)





### Use complex reef*genotype
mod.ori <- glm(cbind(algae_growth)~reef*genotype, data=febP,family= "poisson")
summary(mod.ori)
Anova(mod.ori, test = "F")

glht(mod.ori, mcp(reef="Tukey"))

mod.ori <- glm(cbind(algae_growth)~reef*genotype, data=mayP,family= "poisson")
summary(mod.ori)

mod.ori <- glm(cbind(algae_growth)~reef*genotype, data=augP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(algae_growth)~reef*genotype, data=decP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(algae_growth)~reef*genotype, data=junP,family= "poisson")
summary(mod.ori)
############
# Looe and Conch
#geno B
#looe reef C
#Looe reef C
#One survivor significantly different
# all post-hoc comparisons:
pairs(emmeans(mod.ori, ~ reef*genotype))

pairs(emmeans(mod.ori, ~ reef))
pairs(emmeans(mod.ori, ~ genotype))
#A-C
#A-D
# fixed effect would be genotype
########################### mortality (SAME as ALGAE growth= same)

fit<-goodfit(healthN$mortality)
summary(fit)
rootogram(fit)

ggplot(healthN, aes(x = reef, fill = mortality)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)


mod.orim <- glm(cbind(mortality)~time, data=healthN,family= "poisson")
summary(mod.orim)
# No difference between times
mod.orim <- glm(cbind(mortality)~reef*genotype, data=healthN,family= "poisson")
summary(mod.orim)
# all post-hoc comparisons:
pairs(emmeans(mod.orim, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orim, ~ genotype))
#A-C, B-C, B-D, C-D
pairs(emmeans(mod.orim, ~ reef))
# All significantly different 
###### testing different models

mod.oriq <- glm(cbind(mortality)~reef*genotype, data=healthN,family= "quasipoisson")
summary(mod.oriq)

#Example of VERY bad diviance residuals
mod.oribad <- glm(cbind(mortality)~reef*genotype, data=healthN,family= "gaussian")
summary(mod.oribad)

################# models by time
mod.ori <- glm(cbind(mortality)~reef*genotype, data=febP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(mortality)~reef*genotype, data=mayP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(mortality)~reef*genotype, data=augP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(mortality)~reef*genotype, data=decP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(mortality)~reef*genotype, data=junP,family= "poisson")
summary(mod.ori)
#######
# Looe and Conch
#geno B
#looe reef C
#Looe reef C
#One survivor significantly different

################### % white tissue
ggplot(healthN, aes(x = reef, fill = white)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.oriw <- glm(cbind(white)~time, data=healthN,family= "poisson")
summary(mod.oriw)
#No difference between time
mod.oriw <- glm(cbind(white)~reef*genotype, data=healthN,family= "poisson")
summary(mod.oriw)
# all post-hoc comparisons:
pairs(emmeans(mod.oriw, ~ reef*genotype)) #interactive effect~!~

pairs(emmeans(mod.oriw, ~ reef))
#Cary-Conch, Cary-Looe, Conch-Looe,Conch- Tenn, Looe-Tenn 
pairs(emmeans(mod.oriw, ~ genotype))
#A-B, A-C, A-D, B-C, B-D,  C-D ARE THE SAME

mod.ori <- glm(cbind(white)~reef*genotype, data=febP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(white)~reef*genotype, data=mayP,family= "poisson")
summary(mod.ori)
######
#Coefficients:
#                         Estimate Std. Error z value Pr(>|z|)    
#(Intercept)                1.4469     0.2425   5.966 2.43e-09 ***
#reefConch                 -0.5306     0.3985  -1.331  0.18303    
#reefLooe                   2.6474     0.2510  10.548  < 2e-16 ***
#reefTennessee              1.5488     0.2671   5.799 6.66e-09 ***
#genotypeB                -17.7495  1051.6813  -0.017  0.98653    
#genotypeC                  2.0343     0.2579   7.888 3.08e-15 ***
#genotypeD                  1.1180     0.2794   4.002 6.29e-05 ***
#reefConch:genotypeB       18.0119  1051.6814   0.017  0.98634    
#reefLooe:genotypeB        16.2762  1051.6813   0.015  0.98765    
#reefTennessee:genotypeB   16.7462  1051.6813   0.016  0.98730    
#reefConch:genotypeC       -1.3412     0.4829  -2.777  0.00548 ** 
#reefLooe:genotypeC       -22.4313  1051.6813  -0.021  0.98298    
#reefTennessee:genotypeC   -3.5260     0.3668  -9.612  < 2e-16 ***
#reefConch:genotypeD      -18.3369  1051.6813  -0.017  0.98609    
#reefLooe:genotypeD        -5.2124     0.5764  -9.043  < 2e-16 ***
#reefTennessee:genotypeD   -3.8261     0.5836  -6.556 5.51e-11 ***

mod.ori <- glm(cbind(white)~reef*genotype, data=augP,family= "poisson")
summary(mod.ori)
######
#Coefficients:
#                         Estimate Std. Error z value Pr(>|z|)    
#(Intercept)               1.94591    0.18898  10.297  < 2e-16 ***
#reefConch               -17.24850  637.87696  -0.027  0.97843    
#reefLooe                  1.54299    0.20820   7.411 1.25e-13 ***
#reefTennessee             0.47446    0.24070   1.971  0.04871 *  
#genotypeB                 1.34993    0.21207   6.365 1.95e-10 ***
#genotypeC                 1.04982    0.21958   4.781 1.74e-06 ***
#genotypeD                 1.01160    0.22068   4.584 4.56e-06 ***
#reefConch:genotypeB      -1.34993  902.09423  -0.001  0.99881    
#reefLooe:genotypeB       -1.94846    0.25787  -7.556 4.16e-14 ***
#reefTennessee:genotypeB  -2.16086    0.40890  -5.285 1.26e-07 ***
#reefConch:genotypeC      15.16905  637.87713   0.024  0.98103    
#reefLooe:genotypeC       -2.59281    0.30259  -8.569  < 2e-16 ***
#reefTennessee:genotypeC  -0.94446    0.30073  -3.141  0.00169 ** 
#reefConch:genotypeD      15.90042  637.87701   0.025  0.98011    
#reefLooe:genotypeD       -0.72201    0.24910  -2.899  0.00375 ** 
#reefTennessee:genotypeD  -0.03077    0.29596  -0.104  0.91719  

mod.ori <- glm(cbind(white)~reef*genotype, data=decP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(white)~reef*genotype, data=junP,family= "poisson")
summary(mod.ori)

######################### % pale tissue of living differences May Aug and Dec
fit<-goodfit(healthN$pale_living_tissue)
summary(fit)
rootogram(fit)

ggplot(healthN, aes(x = reef, fill = pale_living_tissue)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orip <- glm(cbind(pale_living_tissue)~time, data=healthN,family= "poisson")
summary(mod.orip)
#No difference in time
mod.orip <- glm(cbind(pale_living_tissue)~reef*genotype, data=healthN,family= "poisson")
summary(mod.orip)
# all post-hoc comparisons:
pairs(emmeans(mod.orip, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orip, ~ genotype))
#A-C, A-D, B-C, B-D
pairs(emmeans(mod.orip, ~ reef))
# All significantly different

mod.ori <- glm(cbind(pale_living_tissue)~reef*genotype, data=febP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(pale_living_tissue)~reef*genotype, data=mayP,family= "poisson")
summary(mod.ori)
##########
#Coefficients:
#                          Estimate Std. Error z value Pr(>|z|)    
#(Intercept)              2.015e+00  1.826e-01  11.036  < 2e-16 ***
#reefConch                1.764e+00  1.976e-01   8.925  < 2e-16 ***
#reefLooe                 1.897e+00  1.958e-01   9.690  < 2e-16 ***
#reefTennessee           -1.792e+00  4.830e-01  -3.709 0.000208 ***
#genotypeB               -8.362e-01  3.320e-01  -2.518 0.011787 *  
#genotypeC                6.837e-15  2.582e-01   0.000 1.000000    
#genotypeD                6.931e-01  2.236e-01   3.100 0.001936 ** 
#reefConch:genotypeB      4.590e-01  3.526e-01   1.302 0.193003    
#reefLooe:genotypeB       3.774e-02  3.555e-01   0.106 0.915450    
#reefTennessee:genotypeB  5.094e+00  5.604e-01   9.091  < 2e-16 ***
#reefConch:genotypeC     -7.027e-01  2.963e-01  -2.372 0.017691 *  
#reefLooe:genotypeC      -1.921e+01  6.379e+02  -0.030 0.975969    
#reefTennessee:genotypeC  3.135e+00  5.247e-01   5.975  2.3e-09 ***
#reefConch:genotypeD     -1.977e+01  6.379e+02  -0.031 0.975269    
#reefLooe:genotypeD      -1.991e+01  6.379e+02  -0.031 0.975103    
#reefTennessee:genotypeD  1.897e+00  5.196e-01   3.651 0.000261 ***
mod.ori <- glm(cbind(pale_living_tissue)~reef*genotype, data=augP,family= "poisson")
summary(mod.ori)
#############
#Coefficients:
#                        Estimate Std. Error z value Pr(>|z|)    
#(Intercept)              3.35864    0.09325  36.017  < 2e-16 ***
#reefConch               -4.74493    1.00434  -4.724 2.31e-06 ***
#reefLooe                 0.73571    0.11341   6.487 8.76e-11 ***
#reefTennessee            0.44802    0.11938   3.753 0.000175 ***
#genotypeB               -0.19106    0.13864  -1.378 0.168193    
#genotypeC               -0.65059    0.15926  -4.085 4.40e-05 ***
#genotypeD               -0.42744    0.14842  -2.880 0.003978 ** 
#reefConch:genotypeB      1.28967    1.16299   1.109 0.267465    
#reefLooe:genotypeB      -0.27895    0.17336  -1.609 0.107610    
#reefTennessee:genotypeB  0.76642    0.17615   4.351 1.35e-05 ***
#reefConch:genotypeC      3.90868    1.04990   3.723 0.000197 ***
#reefLooe:genotypeC      -1.27470    0.24104  -5.288 1.23e-07 ***
#reefTennessee:genotypeC  0.39927    0.19509   2.047 0.040698 *  
#reefConch:genotypeD      1.81374    1.12784   1.608 0.107803    
#reefLooe:genotypeD       0.42744    0.17425   2.453 0.014164 *  
#reefTennessee:genotypeD  0.10202    0.20729   0.492 0.622600    
mod.ori <- glm(cbind(pale_living_tissue)~reef*genotype, data=decP,family= "poisson")
summary(mod.ori)
##########
#Coefficients:
#                    Estimate Std. Error z value Pr(>|z|)    
#(Intercept)           1.3218     0.2582   5.119 3.07e-07 ***
#reefConch             1.7346     0.2801   6.194 5.87e-10 ***
#reefLooe              0.4700     0.3291   1.428 0.153299    
#genotypeB            -0.1178     0.4082  -0.289 0.772958    
#genotypeC            -0.2231     0.3873  -0.576 0.564511    
#genotypeD           -16.6243   637.8770  -0.026 0.979208    
#reefConch:genotypeB   0.7503     0.4297   1.746 0.080823 .  
#reefLooe:genotypeB    1.6126     0.4666   3.456 0.000548 ***
#reefConch:genotypeC   1.0788     0.4144   2.603 0.009241 ** 
#reefLooe:genotypeC    1.2195     0.4550   2.680 0.007362 ** 
#reefConch:genotypeD  16.9266   637.8770   0.027 0.978830    
#reefLooe:genotypeD   18.2338   637.8770   0.029 0.977195    
mod.ori <- glm(cbind(pale_living_tissue)~reef*genotype, data=junP,family= "poisson")
summary(mod.ori)

##################### fish bites no differences
fit<-goodfit(healthN$fish_bites)
summary(fit)
rootogram(fit)

ggplot(healthN, aes(x = reef, fill = fish_bites)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orif <- glm(cbind(fish_bites)~time, data=healthN,family= "poisson")
summary(mod.orif)
#no difference in time
mod.orif <- glm(cbind(fish_bites)~reef*genotype, data=healthN,family= "poisson")
summary(mod.orif)
# all post-hoc comparisons:
pairs(emmeans(mod.orif, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orif, ~ genotype))
# No difference
pairs(emmeans(mod.orif, ~ reef))
# No difference


mod.ori <- glm(cbind(fish_bites)~reef*genotype, data=febP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(fish_bites)~reef*genotype, data=mayP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(fish_bites)~reef*genotype, data=augP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(fish_bites)~reef*genotype, data=decP,family= "poisson")
summary(mod.ori)
mod.ori <- glm(cbind(fish_bites)~reef*genotype, data=junP,family= "poisson")
summary(mod.ori)

###################### healthy no differences 
ggplot(healthN, aes(x = reef, fill = healthy_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)
             
             
mod.orif <- glm(cbind(healthy_y_n)~time, data=healthN,family= "binomial")
summary(mod.orif)
#No difference in time
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=healthN,family= "binomial")
summary(mod.orif)
# all post-hoc comparisons:
pairs(emmeans(mod.orif, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orif, ~ genotype))
# No difference
pairs(emmeans(mod.orif, ~ reef))
# No difference

mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(healthy_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)

####################### Blotchy no differences
ggplot(healthN, aes(x = reef, fill = blotchy_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orih <- glm(cbind(blotchy_y_n)~time, data=healthN,family= "binomial")
summary(mod.orih)
# no difference in time
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=healthN,family= "binomial")
summary(mod.orih)
# all post-hoc comparisons:
pairs(emmeans(mod.orih, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orih, ~ genotype))
# No difference
pairs(emmeans(mod.orih, ~ reef))
# No difference

mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orih)
mod.orih <- glm(cbind(blotchy_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orih)

####################### Disease presence no differences

ggplot(healthN, aes(x = reef, fill = disease_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orid <- glm(cbind(disease_y_n)~time, data=healthN,family= "binomial")
summary(mod.orid)
#no difference in time
mod.orid <- glm(cbind(disease_y_n)~reef*genotype, data=healthN,family= "binomial")
summary(mod.orid)
# all post-hoc comparisons:
pairs(emmeans(mod.orid, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orid, ~ genotype))
# No difference
pairs(emmeans(mod.orid, ~ reef))
# No difference

mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(disease_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)

##################### Tumors no differences

ggplot(healthN, aes(x = reef, fill = tumor_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orit <- glm(cbind(tumor_y_n)~time, data=healthN,family= "binomial")
summary(mod.orit)
#no difference in time
mod.orit <- glm(cbind(tumor_y_n)~reef*genotype, data=healthN,family= "binomial")
summary(mod.orit)
# all post-hoc comparisons:
pairs(emmeans(mod.orit, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orit, ~ genotype))
# No difference
pairs(emmeans(mod.orit, ~ reef))
# No difference

mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(tumor_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)

######################### Boring No differences

ggplot(healthN, aes(x = reef, fill = boring_y_n)) +
    geom_bar(position = "fill") +
    theme_classic()+
  facet_wrap(~time)

mod.orib <- glm(cbind(boring_y_n)~time, data=healthN,family= "binomial")
summary(mod.orib)
#No difference in time
mod.orib <- glm(cbind(boring_y_n)~reef*genotype*time, data=healthN,family= "binomial")
summary(mod.orib)
# all post-hoc comparisons:
pairs(emmeans(mod.orib, ~ reef*genotype)) #interactive effect~!~
pairs(emmeans(mod.orib, ~ genotype))
# No difference
pairs(emmeans(mod.orib, ~ reef))
# No difference
pairs(emmeans(mod.orib, ~ time))
##########
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=febP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=mayP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=augP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=decP,family= "binomial")
summary(mod.orif)
mod.orif <- glm(cbind(boring_y_n)~reef*genotype, data=junP,family= "binomial")
summary(mod.orif)
#### 
```


```{r}

#data_longBi <- gather(healthN, condition, value, c(healthy_y_n, blotchy_y_n:boring_y_n),factor_key=TRUE)
#
#str(data_longBi)
#
#data_longBi$value<-as.factor(data_longBi$value)
#febbi<-subset(data_longBi, time=="0")
#maybi<-subset(data_longBi, time=="1")
#augbi<-subset(data_longBi, time=="2")
#decbi<-subset(data_longBi, time=="3")
#junbi<-subset(data_longBi, time=="4")
```


```{r}
p2 <-  ggplot(HealthN, aes(x = reef, y = healthy_y_n, fill = reef,alpha=genotype)) +
  stat_boxplot(geom= "errorbar", width= 0.5, position = position_dodge(1))+
  #geom_jitter()+
  geom_boxplot(position = position_dodge(1))+
  theme_classic()+
  facet_wrap(~time)+
  scale_fill_manual(values = colors2) +
  scale_alpha_manual(values = alpha_vals)+
  theme(legend.position="right")+
  ylab("Overall health")+
  xlab("")+
  ggtitle("")+
  stat_summary(fun=base::mean, geom="point", size=3, shape=24, position = position_dodge(width = .75))
  #line is median, and closed circle is mean
  #stat_compare_means(label.y=102, method = "kruskal")

p2
ggexport(p2, filename = "Avg_algaeTime.pdf")
```

